<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Templates Gallery - MySertifico</title>
  <link rel="icon" type="image/png" href="../../src/images/logos/favicon.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Remix Icon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&family=EB+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- QRCode.js (davidshimjs) -->
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            poppins: ['Poppins', 'sans-serif'],
            garamond: ['EB Garamond', 'serif'],
            montserrat: ['Montserrat', 'sans-serif'],
          },
          colors: {
            primary: { DEFAULT: '#0d9488', dark: '#0f766e', light: '#ccfbf1' },
            accent:  { DEFAULT: '#f59e0b', hover: '#d97706' },
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }

    select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position:right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em;
      padding-right:2.5rem; appearance:none;
    }
    .dark select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }

    .preview-element{
      position:absolute;
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
      z-index:10;
    }
    .card-preview-elements{ pointer-events:none; z-index:10; }

    #toast-notification { transition: opacity .3s, transform .3s; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

  <!-- ===== Sidebar ===== -->
  <aside id="sidebar" class="sidebar fixed top-0 left-0 z-50 h-full w-64 bg-gray-800 dark:bg-gray-950 text-white transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
    <div class="flex items-center justify-between p-6">
      <h2 class="font-poppins text-2xl font-bold text-white">Menu</h2>
      <button id="close-sidebar" class="text-gray-400 hover:text-white">
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>
    <nav class="p-4">
      <ul class="space-y-2">
        <li>
          <a href="dashboard.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white">
            <i class="ri-dashboard-3-line mr-3 text-lg"></i><span>Dashboard</span>
          </a>
        </li>
        <li>
          <button data-collapse-toggle="submenu-gallery" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg bg-gray-700 text-white transition-colors">
            <span class="flex items-center"><i class="ri-gallery-line mr-3 text-lg"></i><span>Gallery</span></span>
            <i class="ri-arrow-down-s-line transition-transform duration-200 rotate-180"></i>
          </button>
          <ul id="submenu-gallery" class="py-2 space-y-1 pl-8">
            <li><a href="templates-list.html" class="block py-2 px-4 rounded-lg text-sm text-white bg-primary">Templates</a></li>
            <li><a href="logos-badges.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Logos & Badges</a></li>
          </ul>
        </li>
        <li>
          <a href="certificate-list.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
            <i class="ri-award-line mr-3 text-lg"></i><span>Certificates</span>
          </a>
        </li>
        <li>
          <button data-collapse-toggle="submenu-settings" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
            <span class="flex items-center"><i class="ri-settings-3-line mr-3 text-lg"></i><span>Settings</span></span>
            <i class="ri-arrow-down-s-line transition-transform duration-200"></i>
          </button>
          <ul id="submenu-settings" class="hidden py-2 space-y-1 pl-8">
            <li><a href="organisation.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Organisation</a></li>
            <li><a href="logo-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Logos</a></li>
            <li><a href="selected-template-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Selected Templates</a></li>
            <li><a href="user-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Users</a></li>
            <li class="px-4"><hr class="border-gray-700 my-1"></li>
            <li><a href="account.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Account</a></li>
          </ul>
        </li>
        <li class="pt-4 mt-4 border-t border-gray-700">
          <a href="#" id="logout-sidebar" class="flex items-center py-2.5 px-4 rounded-lg text-red-400 hover:bg-red-500 hover:text-white transition-colors">
            <i class="ri-logout-box-r-line mr-3 text-lg"></i><span>Log Out</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- ===== Main ===== -->
  <div id="main-content" class="relative min-h-screen transition-all duration-300 ease-in-out">
    <!-- Navbar -->
    <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between p-4">
        <div class="flex items-center space-x-4">
          <button id="sidebar-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="ri-menu-line text-2xl"></i>
          </button>
          <a href="dashboard.html" class="flex items-center gap-x-2">
            <img src="../../src/images/logos/logo.png" alt="MySertifico Logo" class="h-8 w-8 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';">
            <span class="font-poppins text-2xl font-bold text-primary hidden sm:block">MySertifico</span>
          </a>
        </div>
        <div class="flex items-center space-x-4">
          <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="ri-moon-line block dark:hidden"></i><i class="ri-sun-line hidden dark:block"></i>
          </button>
          <div class="relative">
            <button id="profile-menu-button" class="flex items-center space-x-2">
              <img class="h-9 w-9 rounded-full object-cover" src="https://i.pravatar.cc/150?u=admin" alt="Admin" onerror="this.onerror=null;this.src='https://placehold.co/40x40/0d9488/ffffff?text=A';">
              <div class="hidden md:block text-left">
                <div class="text-sm font-semibold text-gray-800 dark:text-white">Fikri Nabil</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Super Admin</div>
              </div>
            </button>
            <div id="profile-menu" class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5">
              <div class="py-1">
                <a href="my-profile.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-user-line mr-3"></i>My Profile</a>
                <a href="change-password.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-lock-password-line mr-3"></i>Change Password</a>
                <hr class="border-gray-200 dark:border-gray-700 my-1">
                <a href="#" id="logout-navbar" class="flex items-center w-full px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-logout-box-r-line mr-3"></i>Logout</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Page -->
    <main class="p-6 sm:p-8">
      <div class="max-w-7xl mx-auto">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Templates Gallery</h1>
          <p class="text-gray-500 dark:text-gray-400 mt-1">Browse and select a template for your next certificate batch.</p>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6 flex flex-col lg:flex-row gap-4">
          <div class="relative flex-grow">
            <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="search-input" placeholder="Search templates by code..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"/>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:w-auto gap-4">
            <select id="style-filter" class="w-full lg:w-44 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="all">All Styles</option>
              <option value="Modern">Modern</option>
              <option value="Classic">Classic</option>
            </select>
            <select id="orientation-filter" class="w-full lg:w-44 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="all">All Orientations</option>
              <option value="Landscape">Landscape</option>
              <option value="Portrait">Portrait</option>
            </select>
            <select id="alignment-filter" class="w-full lg:w-44 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="all">All Alignments</option>
            </select>
            <select id="color-filter" class="w-full lg:w-44 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="all">All Colors</option>
            </select>
          </div>
        </div>

        <!-- Grid -->
        <div id="templates-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        <div id="no-results" class="hidden text-center py-16">
          <i class="ri-search-eye-line text-6xl text-gray-400 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">No Templates Found</h3>
          <p class="text-gray-500 dark:text-gray-400 mt-1">Your search or filter did not match any templates.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 bg-black/70 z-[120] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div id="preview-modal-panel" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl transform transition-all opacity-0 scale-95 flex flex-col max-h-[92vh]">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 id="preview-modal-title" class="font-poppins font-bold text-lg text-gray-800 dark:text-white">Template Preview</h3>
        <button type="button" id="close-preview-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i class="ri-close-line text-2xl"></i></button>
      </div>
      <div class="p-6 flex-grow overflow-auto bg-gray-100 dark:bg-gray-900">
        <div class="flex items-center justify-center">
          <div id="preview-container" class="relative shadow-lg w-full max-w-[900px]">
            <img id="preview-blanko" src="" class="w-full h-auto" alt="Template Background">
            <div id="preview-elements" class="absolute inset-0"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-700 gap-x-3">
        <button type="button" id="select-template-modal-btn" class="px-4 py-2 text-sm bg-primary text-white rounded-lg hover:bg-primary-dark">
          Add to Selected
        </button>
        <button type="button" id="close-preview-modal-footer" class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-notification" class="fixed top-24 right-6 bg-green-100 border border-green-200 text-green-700 dark:bg-green-900/30 dark:text-green-300 px-4 py-3 rounded-lg shadow-md flex items-center gap-3 transform translate-x-full opacity-0 z-[150]">
    <i class="ri-checkbox-circle-fill text-xl"></i>
    <span id="toast-message"></span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ===== Shell/UI ===== */
      const sidebar = document.getElementById('sidebar');
      const sidebarToggleBtn = document.getElementById('sidebar-toggle');
      const closeSidebarBtn = document.getElementById('close-sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const openSidebar = () => { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
      const closeSidebar = () => { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
      sidebarToggleBtn.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
      closeSidebarBtn.addEventListener('click', closeSidebar);
      overlay.addEventListener('click', closeSidebar);

      const themeToggleBtn = document.getElementById('theme-toggle');
      const applyTheme = () => {
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else document.documentElement.classList.remove('dark');
      };
      applyTheme();
      themeToggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
      });

      const profileMenuButton = document.getElementById('profile-menu-button');
      const profileMenu = document.getElementById('profile-menu');
      profileMenuButton?.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('hidden'); });
      window.addEventListener('click', (e) => {
        if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenuButton.contains(e.target) && !profileMenu.contains(e.target)) {
          profileMenu.classList.add('hidden');
        }
      });

      const logout = () => { window.location.href = "../landing/home.html"; };
      document.getElementById('logout-sidebar').addEventListener('click', e => { e.preventDefault(); logout(); });
      document.getElementById('logout-navbar').addEventListener('click', e => { e.preventDefault(); logout(); });

      /* ===== Constants (Margin & Sizes) ===== */
      const DPI = 96;
      const CM_TO_PX = DPI / 2.54;        // ~37.795
      const MARGIN_PX = 2.0 * CM_TO_PX;   // 2cm
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

      const PORTRAIT_W = 794,  PORTRAIT_H = 1123;
      const LAND_W     = 1123, LAND_H     = 794;

      /* ===== Sample Data: 6 kondisi (kedudukan x/y unik) ===== */
      const portraitLeft = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:120, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:120, position_y:230, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:120, position_y:255, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:120, position_y:275, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:120, position_y:360, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Certificate body text here lorem ipsum dolor sit amet.", position_x:120, position_y:450, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:120, position_y:500, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Event description sample", position_x:120, position_y:540, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:120, position_y:565, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:120, position_y:820, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:120, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:120, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:120, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105555", position_x:560, position_y:860, width:120, height:120 },
      ];
      const portraitCenter = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:397, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:397, position_y:230, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:397, position_y:255, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:397, position_y:275, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:397, position_y:360, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Center aligned sample body text for the certificate.", position_x:397, position_y:440, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:397, position_y:485, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Event description here", position_x:397, position_y:525, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:397, position_y:550, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:260, position_y:820, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:260, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:260, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:260, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105555", position_x:560, position_y:860, width:120, height:120 },
      ];
      const portraitRight = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:670, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:670, position_y:240, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:670, position_y:265, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:670, position_y:285, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:670, position_y:360, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Body text sample at right side.", position_x:670, position_y:445, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:670, position_y:492, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Description right-aligned look", position_x:670, position_y:530, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:670, position_y:555, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:670, position_y:820, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:670, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:670, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:670, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105555", position_x:260, position_y:860, width:120, height:120 },
      ];
      const landscapeLeft = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:100, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:100, position_y:220, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:100, position_y:240, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:100, position_y:260, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:100, position_y:320, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Landscape body left side.", position_x:100, position_y:390, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:100, position_y:430, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Event details here", position_x:100, position_y:465, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:100, position_y:490, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:100, position_y:590, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:100, position_y:630, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:100, position_y:650, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:100, position_y:700, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105555", position_x:900, position_y:590, width:120, height:120 },
      ];
      const landscapeCenter = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:561, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:561, position_y:220, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:561, position_y:240, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:561, position_y:260, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:561, position_y:305, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Centered landscape certificate body text.", position_x:561, position_y:370, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:561, position_y:410, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Event centered description", position_x:561, position_y:445, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:561, position_y:470, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:350, position_y:580, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:350, position_y:640, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:350, position_y:665, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:350, position_y:690, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105565", position_x:900, position_y:600, width:120, height:120 },
      ];
      const landscapeRight = [
        { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:1000, position_y:150, width:120, height:120 },
        { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:1000, position_y:220, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" },
        { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:1000, position_y:240, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:1000, position_y:260, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:1000, position_y:320, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" },
        { element_id:"certificate_body", type:"text", content:"Right-side layout example text.", position_x:1000, position_y:390, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:1000, position_y:430, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" },
        { element_id:"event_description", type:"text", content:"Event description area", position_x:1000, position_y:465, font_family:"Montserrat", font_size:16, color:"#374151" },
        { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:1000, position_y:490, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" },
        { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:1000, position_y:600, width:200, height:150 },
        { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:1000, position_y:640, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" },
        { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:1000, position_y:665, font_family:"Montserrat", font_size:14, color:"#374151" },
        { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:1000, position_y:690, font_family:"Montserrat", font_size:12, color:"#374151" },
        { element_id:"qr_code", type:"qrcode", content:"https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105545", position_x:250, position_y:600, width:150, height:150 },
      ];

      const templatesData = [
        { id: 1, template_code:'MDPL-GREEN-001',  style:'Modern',  orientation:'Portrait',  alignment:'Left',   theme_color:'Green',  imageUrl:'../../src/images/templates/mdpl-green-001.svg',  content:portraitLeft,    original_width:PORTRAIT_W, original_height:PORTRAIT_H },
        { id: 2, template_code:'MDPC-GOLD-002',   style:'Modern',  orientation:'Portrait',  alignment:'Center', theme_color:'Gold',   imageUrl:'../../src/images/templates/clpc-gold-010.svg',  content:portraitCenter,  original_width:PORTRAIT_W, original_height:PORTRAIT_H },
        { id: 3, template_code:'MDPR-BLUE-003',   style:'Modern',  orientation:'Portrait',  alignment:'Right',  theme_color:'Blue',   imageUrl:'../../src/images/templates/mdpr-blue-003.svg',  content:portraitRight,   original_width:PORTRAIT_W, original_height:PORTRAIT_H },
        { id: 4, template_code:'CLLL-RED-004',    style:'Classic', orientation:'Landscape', alignment:'Left',   theme_color:'Red',    imageUrl:'../../src/images/templates/clll-red-004.svg',   content:landscapeLeft,   original_width:LAND_W,     original_height:LAND_H     },
        { id: 5, template_code:'MDLC-PURPLE-005', style:'Modern',  orientation:'Landscape', alignment:'Center', theme_color:'Purple', imageUrl:'../../src/images/templates/mdlc-purple-003.svg', content:landscapeCenter, original_width:LAND_W,     original_height:LAND_H     },
        { id: 6, template_code:'CLLR-BLACK-006',  style:'Classic', orientation:'Landscape', alignment:'Right',  theme_color:'Black',  imageUrl:'../../src/images/templates/cllr-black-006.svg', content:landscapeRight,  original_width:LAND_W,     original_height:LAND_H     },
      ];

      /* ===== Filters ===== */
      const templatesGrid = document.getElementById('templates-grid');
      const noResultsDiv = document.getElementById('no-results');
      const searchInput = document.getElementById('search-input');
      const styleFilter = document.getElementById('style-filter');
      const orientationFilter = document.getElementById('orientation-filter');
      const alignmentFilter = document.getElementById('alignment-filter');
      const colorFilter = document.getElementById('color-filter');

      function populateFilters(){
        const alignments = [...new Set(templatesData.map(t => t.alignment))];
        const colors     = [...new Set(templatesData.map(t => t.theme_color))];
        alignments.forEach(a => alignmentFilter.innerHTML += `<option value="${a}">${a}</option>`);
        colors.forEach(c => colorFilter.innerHTML += `<option value="${c}">${c}</option>`);
      }

      /* ===== Anchor / Overlay / QR Helpers (selaras dengan Selected Templates) ===== */
      function xAnchorStyle(template, xPx){
        const w = template.original_width;
        if (template.alignment === 'Left'){
          const leftPercent = (xPx / w) * 100;
          return { xStyle: `left:${leftPercent}%;`, transform: 'translateY(-50%)', textAlign: 'left' };
        }
        if (template.alignment === 'Right'){
          const rightPx = Math.max(0, w - xPx);
          const rightPercent = (rightPx / w) * 100;
          return { xStyle: `right:${rightPercent}%;`, transform: 'translateY(-50%)', textAlign: 'right' };
        }
        // Center
        const leftPercent = (xPx / w) * 100;
        return { xStyle: `left:${leftPercent}%;`, transform: 'translate(-50%, -50%)', textAlign: 'center' };
      }

      function generateOverlayElements(template, scaleFactor){
        const contentWidth  = template.original_width  - 2 * MARGIN_PX;
        // const contentHeight = template.original_height - 2 * MARGIN_PX; // jika perlu

        return template.content.map(el => {
          const safeY = clamp(el.position_y, MARGIN_PX, template.original_height - MARGIN_PX);
          const topPercent = (safeY / template.original_height) * 100;
          const { xStyle, transform, textAlign } = xAnchorStyle(template, el.position_x);

          let baseStyle = `top:${topPercent}%;${xStyle}transform:${transform};`;

          if (el.type === 'text'){
            const fs = el.font_size || 14, lh = fs * 1.2;
            const wPx = Math.min(contentWidth, (template.orientation === 'Portrait' ? 520 : 720));
            baseStyle += `font-family:'${el.font_family || 'Montserrat'}',sans-serif;` +
                         `font-size:${fs * scaleFactor}px;` +
                         `line-height:${lh * scaleFactor}px;` +
                         `font-weight:${el.font_weight || 'normal'};` +
                         `color:${el.color || '#111827'};` +
                         `text-align:${textAlign};` +
                         `max-width:${wPx * scaleFactor}px;`;
            return `<div class="preview-element" data-element-id="${el.element_id}" style="${baseStyle}">${el.content}</div>`;
          }

          if (el.type === 'image'){
            const w = (el.width  || 120) * scaleFactor;
            const h = (el.height || 120) * scaleFactor;
            baseStyle += `width:${w}px;height:${h}px;`;
            return `<img class="preview-element" data-element-id="${el.element_id}" src="${el.content}" style="${baseStyle}" alt="${el.element_id}" onerror="this.style.display='none'">`;
          }

          if (el.type === 'qrcode'){
            const w = (el.width  || 100) * scaleFactor;
            const h = (el.height || w)   * scaleFactor;
            baseStyle += `width:${w}px;height:${h}px;`;
            return `<div class="preview-element qr-holder" data-element-id="${el.element_id}" data-text="${el.content}" style="${baseStyle}"></div>`;
          }

          return '';
        }).join('');
      }

      function renderQRCodesIn(container){
        const holders = container.querySelectorAll('.qr-holder');
        holders.forEach(holder => {
          const text = holder.dataset.text || '';
          const width  = parseFloat(holder.style.width)  || 100;
          const height = parseFloat(holder.style.height) || width;
          holder.innerHTML = '';
          if (!text) return;
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              new QRCode(holder, {
                text,
                width,
                height,
                colorDark : "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
              });
            });
          });
        });
      }

      function ensureOneQRCode(template){
        const exists = template.content.some(el => el.type === 'qrcode');
        if (exists) return template;
        const fallback = {
          element_id: "qr_code_auto",
          type: "qrcode",
          content: "https://des.mysertifico.com/verify.html?id=auto",
          position_x: template.original_width - MARGIN_PX,
          position_y: template.original_height - MARGIN_PX,
          width: 100,
          height: 100
        };
        return { ...template, content: [...template.content, fallback] };
      }

      /* ===== Render GRID (kad dengan overlay elemen + QR) ===== */
      function renderTemplates(list){
        templatesGrid.innerHTML = '';
        noResultsDiv.classList.toggle('hidden', list.length > 0);

        list.forEach(t => {
          const template = ensureOneQRCode(t);
          const card = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden group transform hover:-translate-y-1 transition-all duration-300">
              <div class="relative bg-gray-200 dark:bg-gray-700">
                <div class="preview-card-container relative w-full" style="aspect-ratio:${template.original_width}/${template.original_height};">
                  <img class="absolute inset-0 w-full h-full object-contain" src="${template.imageUrl}" alt="${template.template_code}" onerror="this.onerror=null;this.src='https://placehold.co/600x424/cccccc/333333?text=Image+Error';">
                  <div class="card-preview-elements absolute inset-0" data-template-id="${template.id}"></div>
                </div>
                <div class="absolute inset-0 z-20 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-all duration-300 flex items-center justify-center gap-2">
                  <button data-id="${template.id}" class="preview-btn opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all duration-300 bg-white/80 text-gray-800 font-semibold py-2 px-4 rounded-lg inline-flex items-center gap-2 hover:bg-white">
                    <i class="ri-eye-line"></i><span>Preview</span>
                  </button>
                  <button data-id="${template.id}" class="select-btn opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all duration-300 delay-75 bg-primary text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center gap-2">
                    <i class="ri-check-line"></i><span>Add</span>
                  </button>
                </div>
              </div>
              <div class="p-4">
                <h3 class="font-semibold text-gray-800 dark:text-white">${template.template_code}</h3>
                <div class="flex items-center flex-wrap gap-2 mt-2 text-xs text-gray-600 dark:text-gray-300">
                  <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full">${template.style}</span>
                  <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full">${template.orientation}</span>
                  <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full">${template.alignment}</span>
                  <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full">${template.theme_color}</span>
                </div>
              </div>
            </div>
          `;
          templatesGrid.insertAdjacentHTML('beforeend', card);
        });

        renderAllCardOverlays();
      }

      function renderAllCardOverlays(){
        const holders = document.querySelectorAll('.card-preview-elements');
        holders.forEach(holder => {
          const id = parseInt(holder.dataset.templateId, 10);
          const template = ensureOneQRCode(templatesData.find(t => t.id === id));
          if (!template) return;

          const container = holder.closest('.preview-card-container');
          if (!container) return;

          const rect = container.getBoundingClientRect();
          const scale = rect.width / template.original_width;

          holder.innerHTML = generateOverlayElements(template, scale);
          renderQRCodesIn(holder);
        });
      }

      /* ===== Preview Modal ===== */
      const previewModal = document.getElementById('preview-modal');
      const previewModalPanel = document.getElementById('preview-modal-panel');
      const previewModalTitle = document.getElementById('preview-modal-title');
      const closePreviewModalBtn = document.getElementById('close-preview-modal');
      const closePreviewModalFooterBtn = document.getElementById('close-preview-modal-footer');
      const selectTemplateModalBtn = document.getElementById('select-template-modal-btn');
      const previewContainer = document.getElementById('preview-container');
      const previewBlanko = document.getElementById('preview-blanko');
      const previewElements = document.getElementById('preview-elements');

      let currentPreviewId = null;

      function openPreviewModal(templateId){
        let t = templatesData.find(x => x.id === templateId);
        if (!t) return;
        t = ensureOneQRCode(t);
        currentPreviewId = t.id;

        previewModalTitle.textContent = `Preview: ${t.template_code}`;
        previewBlanko.src = t.imageUrl;

        previewContainer.style.aspectRatio = `${t.original_width} / ${t.original_height}`;
        previewContainer.style.maxWidth = t.orientation === 'Portrait' ? '520px' : '900px';

        previewElements.innerHTML = '';
        setTimeout(() => {
          const rect = previewContainer.getBoundingClientRect();
          const scale = rect.width / t.original_width;
          previewElements.innerHTML = generateOverlayElements(t, scale);
          renderQRCodesIn(previewElements);
        }, 50);

        previewModal.classList.remove('hidden');
        previewModal.classList.add('flex');
        setTimeout(() => previewModalPanel.classList.remove('opacity-0','scale-95'), 10);
      }

      function closePreviewModal(){
        previewModalPanel.classList.add('opacity-0','scale-95');
        setTimeout(() => { previewModal.classList.add('hidden'); previewModal.classList.remove('flex'); }, 300);
      }

      closePreviewModalBtn.addEventListener('click', closePreviewModal);
      closePreviewModalFooterBtn.addEventListener('click', closePreviewModal);
      previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closePreviewModal(); });

      /* ===== Toast ===== */
      const toast = document.getElementById('toast-notification');
      const toastMessage = document.getElementById('toast-message');
      function showToast(message){
        toastMessage.textContent = message;
        toast.classList.remove('translate-x-full','opacity-0');
        setTimeout(() => toast.classList.add('translate-x-full','opacity-0'), 3000);
      }

      /* ===== Select (Add to Selected) ===== */
      function addToSelected(templateId){
        try{
          const storeKey = 'mysertifico_selected_templates';
          const existing = JSON.parse(localStorage.getItem(storeKey) || '[]');
          if (!existing.includes(templateId)) existing.push(templateId);
          localStorage.setItem(storeKey, JSON.stringify(existing));
          showToast("Template added! Check it in 'Selected Templates'.");
        }catch(e){
          console.warn(e);
          showToast("Added (demo).");
        }
      }

      selectTemplateModalBtn.addEventListener('click', () => {
        if (currentPreviewId != null) addToSelected(currentPreviewId);
      });

      /* ===== Events: Grid buttons ===== */
      templatesGrid.addEventListener('click', (e) => {
        const selectBtn = e.target.closest('.select-btn');
        if (selectBtn){
          const id = parseInt(selectBtn.dataset.id, 10);
          addToSelected(id);
        }
        const previewBtn = e.target.closest('.preview-btn');
        if (previewBtn){
          const id = parseInt(previewBtn.dataset.id, 10);
          openPreviewModal(id);
        }
      });

      /* ===== Filters ===== */
      function applyFilters(){
        const term = (searchInput.value || '').toLowerCase();
        const fStyle       = styleFilter.value;
        const fOrientation = orientationFilter.value;
        const fAlignment   = alignmentFilter.value;
        const fColor       = colorFilter.value;

        const filtered = templatesData.filter(t =>
          t.template_code.toLowerCase().includes(term) &&
          (fStyle       === 'all' || t.style        === fStyle) &&
          (fOrientation === 'all' || t.orientation  === fOrientation) &&
          (fAlignment   === 'all' || t.alignment    === fAlignment) &&
          (fColor       === 'all' || t.theme_color  === fColor)
        );
        renderTemplates(filtered);
      }
      [searchInput, styleFilter, orientationFilter, alignmentFilter, colorFilter].forEach(el => el.addEventListener('input', applyFilters));

      /* ===== Resize re-render overlays ===== */
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { renderAllCardOverlays(); }, 150);
      });

      /* ===== Init ===== */
      populateFilters();
      renderTemplates(templatesData);
      applyFilters();
    });
  </script>
</body>
</html>
