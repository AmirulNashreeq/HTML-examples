<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top Up Tokens - MySertifico</title>
  <link rel="icon" type="image/png" href="../../src/images/logos/favicon.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';"/>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&family=EB+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            poppins: ['Poppins', 'sans-serif'],
            garamond: ['EB Garamond', 'serif'],
            montserrat: ['Montserrat', 'sans-serif'],
          },
          colors: {
            primary: { DEFAULT: '#0d9488', dark: '#0f766e', light: '#ccfbf1' },
            accent: { DEFAULT: '#f59e0b', hover: '#d97706' },
          },
        },
      },
    };
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em; padding-right:2.5rem; appearance:none;
    }
    .dark select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    .input-error { border-color: #ef4444 !important; }
    .help-error { color: #ef4444; }
    .step-panel { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .nav-active { background-color: #0f766e; color:#fff !important; box-shadow: 0 1px 2px rgb(0 0 0 / .1); }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

  <aside id="sidebar" class="sidebar fixed top-0 left-0 z-50 h-full w-64 bg-gray-800 dark:bg-gray-950 text-white transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
     <div class="flex items-center justify-between p-6">
       <h2 class="font-poppins text-2xl font-bold text-white">Menu</h2>
       <button id="close-sidebar" class="text-gray-400 hover:text-white">
         <i class="ri-close-line text-2xl"></i>
       </button>
     </div>
     <nav class="p-4">
       <ul class="space-y-2">
         <li>
           <a href="dashboard.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors" data-route="dashboard.html">
             <i class="ri-dashboard-3-line mr-3 text-lg"></i>
             <span>Dashboard</span>
           </a>
         </li>
         <li>
           <button data-collapse-toggle="submenu-gallery" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
             <span class="flex items-center"><i class="ri-gallery-line mr-3 text-lg"></i><span>Gallery</span></span>
             <i class="ri-arrow-down-s-line transition-transform duration-200"></i>
           </button>
           <ul id="submenu-gallery" class="hidden py-2 space-y-1 pl-8">
             <li><a href="templates-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="templates-list.html">Templates</a></li>
             <li><a href="logos-badges.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="logos-badges.html">Logos & Badges</a></li>
           </ul>
         </li>
         <li>
           <a href="certificate-list.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors" data-route="certificate-list.html">
             <i class="ri-award-line mr-3 text-lg"></i>
             <span>Certificates</span>
           </a>
         </li>
         <li>
            <a href="find-certificate.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
                <i class="ri-user-search-line mr-3 text-lg"></i>
                <span>Find Certificate</span>
            </a>
        </li>
         <li>
           <button data-collapse-toggle="submenu-settings" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
             <span class="flex items-center"><i class="ri-settings-3-line mr-3 text-lg"></i><span>Settings</span></span>
             <i class="ri-arrow-down-s-line transition-transform duration-200"></i>
           </button>
           <ul id="submenu-settings" class="hidden py-2 space-y-1 pl-8">
             <li><a href="organisation.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="organisation.html">Organisation</a></li>
             <li><a href="logo-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="logo-list.html">Logos</a></li>
             <li><a href="selected-template-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="selected-template-list.html">Selected Templates</a></li>
             <li><a href="user-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="user-list.html">Users</a></li>
             <li class="px-4"><hr class="border-gray-700 my-1"></li>
             <li><a href="account.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="account.html">Account</a></li>
           </ul>
         </li>
         <li class="pt-4 mt-4 border-t border-gray-700">
           <a href="#" id="logout-sidebar" class="flex items-center py-2.5 px-4 rounded-lg text-red-400 hover:bg-red-500 hover:text-white transition-colors">
             <i class="ri-logout-box-r-line mr-3 text-lg"></i>
             <span>Log Out</span>
           </a>
         </li>
       </ul>
     </nav>
  </aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
  <div id="main-content" class="relative min-h-screen transition-all duration-300 ease-in-out">
     <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
       <div class="flex items-center justify-between p-4">
         <div class="flex items-center space-x-4">
           <button id="sidebar-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
             <i class="ri-menu-line text-2xl"></i>
           </button>
           <a href="dashboard.html" class="flex items-center gap-x-2">
             <img src="../../src/images/logos/logo.png" alt="MySertifico Logo" class="h-8 w-8 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';">
             <span class="font-poppins text-2xl font-bold text-primary hidden sm:block">MySertifico</span>
           </a>
         </div>
         <div class="flex items-center space-x-4">
           <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
             <i class="ri-moon-line block dark:hidden"></i>
             <i class="ri-sun-line hidden dark:block"></i>
           </button>
           <div class="relative">
             <button id="profile-menu-button" class="flex items-center space-x-2">
               <img class="h-9 w-9 rounded-full object-cover" src="https://i.pravatar.cc/150?u=admin" alt="Admin" onerror="this.onerror=null;this.src='https://placehold.co/40x40/0d9488/ffffff?text=A';">
               <div class="hidden md:block text-left">
                 <div class="text-sm font-semibold text-gray-800 dark:text-white">Fikri Nabil</div>
                 <div class="text-xs text-gray-500 dark:text-gray-400">Super Admin</div>
               </div>
             </button>
             <div id="profile-menu" class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
               <div class="py-1">
                 <a href="my-profile.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-user-line mr-3"></i>My Profile</a>
                 <a href="change-password.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-lock-password-line mr-3"></i>Change Password</a>
                 <hr class="border-gray-200 dark:border-gray-700 my-1">
                 <a href="#" id="logout-navbar" class="flex items-center w-full px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-logout-box-r-line mr-3"></i>Logout</a>
               </div>
             </div>
           </div>
         </div>
       </div>
     </header>

     <main class="p-6 sm:p-8">
       <div class="max-w-7xl mx-auto">

         <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
           <div>
             <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Top Up Tokens</h1>
             <p class="text-gray-500 dark:text-gray-400 mt-1">Follow the steps below to add more tokens to your account.</p>
           </div>
           <a href="account.html" class="w-full md:w-auto justify-center px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center">
             <i class="ri-arrow-left-line mr-2"></i>
             <span>Back to Account</span>
           </a>
         </div>

         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
           <form id="topup-form" class="lg:col-span-2 space-y-8">

             <div class="flex items-center">
                 <div id="step-nav-1" class="step-nav-item flex flex-col items-center text-primary relative w-1/2">
                     <div class="rounded-full transition duration-500 ease-in-out h-10 w-10 flex items-center justify-center border-2 border-primary bg-primary text-white">
                         <span class="font-bold text-lg">1</span>
                     </div>
                     <div class="mt-3 text-xs font-medium uppercase text-primary text-center">Choose Pack</div>
                 </div>
                 <div class="flex-auto border-t-2 transition duration-500 ease-in-out border-gray-300 dark:border-gray-600"></div>
                 <div id="step-nav-2" class="step-nav-item flex flex-col items-center text-gray-500 relative w-1/2">
                     <div class="rounded-full transition duration-500 ease-in-out h-10 w-10 flex items-center justify-center border-2 border-gray-300 dark:border-gray-600">
                         <span class="font-bold text-lg">2</span>
                     </div>
                     <div class="mt-3 text-xs font-medium uppercase text-gray-500 text-center">Payment</div>
                 </div>
             </div>
             <div id="step-1" class="step-panel bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
               <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Step 1: Choose a pack</h2>
               <div id="packs" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                 <label class="group relative cursor-pointer rounded-2xl p-6 text-center shadow-lg border border-teal-200 dark:border-teal-700 bg-white dark:bg-gray-800 hover:shadow-xl transition-all">
                   <input type="radio" name="pack" value="rm50" class="peer sr-only">
                   <div class="mx-auto mb-3 w-12 h-12 rounded-xl bg-teal-50 dark:bg-teal-900/40 flex items-center justify-center"><i class="ri-leaf-line text-xl text-teal-600 dark:text-teal-300"></i></div>
                   <h4 class="text-lg font-bold text-primary">Topup RM50</h4>
                   <p class="text-4xl font-extrabold my-2 text-gray-900 dark:text-white">333 <span class="text-base font-normal">tokens</span></p>
                   <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">≈ 0.15 sen per recipient</p>
                   <div class="bg-emerald-50 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-200 text-sm font-medium py-2 px-4 rounded-lg">Pay-as-you-go</div>
                   <div class="absolute inset-0 rounded-2xl ring-2 ring-transparent peer-checked:ring-primary pointer-events-none"></div>
                 </label>
                 <label class="group relative cursor-pointer rounded-2xl p-6 text-center shadow-2xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white hover:shadow-[0_20px_40px_rgba(16,185,129,0.35)] transition-all overflow-visible">
                   <span class="absolute top-2 right-2 z-20 bg-amber-400 text-amber-900 text-[10px] font-bold px-2 py-0.5 rounded-full ring-1 ring-white shadow">POPULAR</span>
                   <input type="radio" name="pack" value="rm100" class="peer sr-only">
                   <div class="mx-auto mb-3 w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center"><i class="ri-rocket-2-line text-xl"></i></div>
                   <h4 class="text-lg font-bold">Topup RM100</h4>
                   <p class="text-4xl font-extrabold my-2">769 <span class="text-base font-normal">tokens</span></p>
                   <p class="text-xs text-emerald-100 mb-4">Save 13% — Only ≈ 0.13 sen</p>
                   <div class="bg-white/15 text-white text-sm font-medium py-2 px-4 rounded-lg">Best value</div>
                   <div class="absolute inset-0 rounded-2xl ring-2 ring-transparent peer-checked:ring-white/80 pointer-events-none"></div>
                 </label>
                 <label class="group relative cursor-pointer rounded-2xl p-6 text-center shadow-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white hover:shadow-[0_20px_40px_rgba(99,102,241,0.35)] transition-all overflow-visible">
                   <span class="absolute top-2 right-2 z-20 bg-amber-400 text-amber-900 text-[10px] font-bold px-2 py-0.5 rounded-full ring-1 ring-white shadow">SUPER SAVE!</span>
                   <input type="radio" name="pack" value="rm200" class="peer sr-only">
                   <div class="mx-auto mb-3 w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center"><i class="ri-vip-crown-line text-xl"></i></div>
                   <h4 class="text-lg font-bold">Topup RM200</h4>
                   <p class="text-4xl font-extrabold my-2">2,000 <span class="text-base font-normal">tokens</span></p>
                   <p class="text-xs text-indigo-100 mb-4">Save 33% — Only ≈ 0.10 sen</p>
                   <div class="bg-white/15 text-white text-sm font-medium py-2 px-4 rounded-lg">For heavy issuers</div>
                   <div class="absolute inset-0 rounded-2xl ring-2 ring-transparent peer-checked:ring-white/80 pointer-events-none"></div>
                 </label>
               </div>
             </div>

             <div id="step-2" class="step-panel hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Step 2: Payment Method</h2>
                <div class="grid sm:grid-cols-3 gap-4">
                  <label class="flex items-center gap-3 p-4 rounded-lg border border-gray-300 dark:border-gray-600 hover:border-primary cursor-pointer has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary">
                    <input type="radio" name="paymethod" value="fpx" class="sr-only" checked>
                    <i class="ri-bank-card-2-line text-xl text-primary"></i>
                    <span class="font-medium text-gray-800 dark:text-gray-100">FPX / Online Banking</span>
                  </label>
                  <label class="flex items-center gap-3 p-4 rounded-lg border border-gray-300 dark:border-gray-600 hover:border-primary cursor-pointer has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary">
                    <input type="radio" name="paymethod" value="card" class="sr-only">
                    <i class="ri-credit-card-2-line text-xl text-primary"></i>
                    <span class="font-medium text-gray-800 dark:text-gray-100">Credit / Debit Card</span>
                  </label>
                  <label class="flex items-center gap-3 p-4 rounded-lg border border-gray-300 dark:border-gray-600 hover:border-primary cursor-pointer has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary">
                    <input type="radio" name="paymethod" value="duitnow" class="sr-only">
                    <i class="ri-qr-code-line text-xl text-primary"></i>
                    <span class="font-medium text-gray-800 dark:text-gray-100">QR Code (DuitNow)</span>
                  </label>
                </div>
             </div>

             <div class="flex justify-between pt-4">
                 <button id="btn-prev" type="button" class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-2">
                     <i class="ri-arrow-left-line text-lg"></i>
                     <span>Previous</span>
                 </button>
                 <button id="btn-next" type="button" class="px-4 py-2 text-sm bg-primary text-white rounded-lg hover:bg-primary-dark focus:outline-none focus:ring-4 focus:ring-primary/50 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                     <span>Next</span>
                     <i class="ri-arrow-right-line text-lg"></i>
                 </button>
                 <button id="btn-submit" type="submit" class="hidden px-4 py-2 text-sm bg-accent text-white rounded-lg hover:bg-accent-hover focus:outline-none focus:ring-4 focus:ring-accent/50 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                     <i class="ri-shield-check-line text-lg"></i>
                     <span>Proceed to Payment</span>
                 </button>
             </div>
           </form>

           <aside class="lg:col-span-1">
             <div class="sticky top-24 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
               <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Order Summary</h2>
               <div class="space-y-3 text-sm">
                 <div class="flex items-center justify-between">
                   <span class="text-gray-600 dark:text-gray-300">Selected Pack</span>
                   <span id="sum-pack" class="font-medium text-gray-900 dark:text-white">—</span>
                 </div>
                 <div class="flex items-center justify-between">
                   <span class="text-gray-600 dark:text-gray-300">Tokens</span>
                   <span id="sum-tokens" class="font-medium text-gray-900 dark:text-white">—</span>
                 </div>
                 <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                 <div class="flex items-center justify-between">
                   <span class="text-gray-600 dark:text-gray-300">Subtotal</span>
                   <span id="sum-subtotal" class="font-semibold">RM 0.00</span>
                 </div>
                 <div class="flex items-center justify-between">
                   <span class="text-gray-600 dark:text-gray-300">SST (8%)</span>
                   <span id="sum-sst" class="font-semibold">RM 0.00</span>
                 </div>
                 <div class="flex items-center justify-between text-lg font-bold pt-2">
                   <span class="text-gray-800 dark:text-white">Grand Total</span>
                   <span id="sum-grand" class="text-primary">RM 0.00</span>
                 </div>
               </div>
               <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">* All prices are final. Tokens will be credited after successful payment.</p>
             </div>
           </aside>
         </div>

       </div>
     </main>
  </div>

<script>
    // ===== Shell UI Logic (Sidebar, Theme, etc) =====
    document.addEventListener('DOMContentLoaded', () => {
       const sidebar = document.getElementById('sidebar');
       const sidebarToggleBtn = document.getElementById('sidebar-toggle');
       const closeSidebarBtn = document.getElementById('close-sidebar');
       const overlay = document.getElementById('sidebar-overlay');
       function openSidebar(){ sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
       function closeSidebar(){ sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
       sidebarToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
       closeSidebarBtn.addEventListener('click', closeSidebar);
       overlay.addEventListener('click', closeSidebar);

       const themeToggleBtn = document.getElementById('theme-toggle');
       const applyTheme = () => {
         if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
           document.documentElement.classList.add('dark');
         } else {
           document.documentElement.classList.remove('dark');
         }
       };
       applyTheme();
       themeToggleBtn.addEventListener('click', ()=>{
         const isDark = document.documentElement.classList.toggle('dark');
         localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
       });

       const profileMenuButton = document.getElementById('profile-menu-button');
       const profileMenu = document.getElementById('profile-menu');
       profileMenuButton?.addEventListener('click', (e)=>{ e.stopPropagation(); profileMenu.classList.toggle('hidden'); });
       window.addEventListener('click', (e)=>{
         if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenuButton.contains(e.target) && !profileMenu.contains(e.target)) {
           profileMenu.classList.add('hidden');
         }
       });

       const logout = () => { window.location.href = "../landing/home.html"; };
       document.getElementById('logout-sidebar').addEventListener('click', e => { e.preventDefault(); logout(); });
       document.getElementById('logout-navbar').addEventListener('click', e => { e.preventDefault(); logout(); });

      /* ====== Sidebar memory ====== */
      const NAV_KEY = 'mys_sidebar_memory';
      const getFile = (href) => (href || '').split('/').pop();
      const currentFile = getFile(window.location.pathname);

      function saveNavState(state){ try { localStorage.setItem(NAV_KEY, JSON.stringify(state)); } catch(e){} }
      function readNavState(){ try { return JSON.parse(localStorage.getItem(NAV_KEY) || '{}'); } catch(e){ return {}; } }

      function restoreSidebar(){
        const state = readNavState();
        document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
          const targetId = btn.getAttribute('data-collapse-toggle');
          const ul = document.getElementById(targetId);
          const arrow = btn.querySelector('.ri-arrow-down-s-line');
          const open = state.open?.[targetId] ?? false;
          if (ul){
            ul.classList.toggle('hidden', !open);
            if (arrow) arrow.classList.toggle('rotate-180', open);
            if (open) { btn.classList.add('bg-gray-700','text-white'); }
          }
        });
        const activeRoute = state.active || currentFile;
        setActiveLink(activeRoute);
      }

      function setActiveLink(routeFile){
        document.querySelectorAll('nav a[data-route]').forEach(a => {
          a.classList.remove('nav-active', 'text-white');
          a.classList.add('text-gray-400');
        });
        const target = Array.from(document.querySelectorAll('nav a[data-route]')).find(a => a.dataset.route === routeFile);
        if (target){
          target.classList.add('nav-active');
          target.classList.remove('text-gray-400');
          const parentUl = target.closest('ul[id^="submenu-"]');
          if (parentUl){
            const btn = document.querySelector(`[data-collapse-toggle="${parentUl.id}"]`);
            const arrow = btn?.querySelector('.ri-arrow-down-s-line');
            parentUl.classList.remove('hidden');
            btn?.classList.add('bg-gray-700','text-white');
            arrow?.classList.add('rotate-180');
          }
          const state = readNavState();
          state.active = routeFile;
          state.open = state.open || {};
          document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
            const id = btn.getAttribute('data-collapse-toggle');
            state.open[id] = !document.getElementById(id)?.classList.contains('hidden');
          });
          saveNavState(state);
        }
      }

      document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-collapse-toggle');
          const ul = document.getElementById(id);
          const arrow = btn.querySelector('.ri-arrow-down-s-line');
          if (!ul) return;
          ul.classList.toggle('hidden');
          arrow?.classList.toggle('rotate-180');
          btn.classList.toggle('bg-gray-700');
          btn.classList.toggle('text-white');
          const state = readNavState();
          state.open = state.open || {};
          state.open[id] = !ul.classList.contains('hidden');
          saveNavState(state);
        });
      });

      document.querySelectorAll('nav a[data-route]').forEach(a => a.addEventListener('click', () => setActiveLink(a.dataset.route)));
      
      setActiveLink('account.html');
      restoreSidebar();

    });

    // ===== Multi-Step Form Logic =====
    (function(){
      // ----- CONFIG & CONSTANTS -----
      const PACKS = {
        rm50:  { label: 'Topup RM50',  price: 50,  tokens: 333 },
        rm100: { label: 'Topup RM100', price: 100, tokens: 769 },
        rm200: { label: 'Topup RM200', price: 200, tokens: 2000 },
      };
      const SST_RATE = 0.08;
      const $ = (selector) => document.querySelector(selector);
      const $$ = (selector) => document.querySelectorAll(selector);

      // ----- STATE MANAGEMENT -----
      const state = {
        currentStep: 1,
        selectedPack: null,
        paymentMethod: 'fpx',
        isStepValid: [false, false]
      };

      // ----- DOM ELEMENTS -----
      const form = $('#topup-form');
      const stepPanels = [$('#step-1'), $('#step-2')];
      const stepNavs = [$('#step-nav-1'), $('#step-nav-2')];
      const btnPrev = $('#btn-prev');
      const btnNext = $('#btn-next');
      const btnSubmit = $('#btn-submit');

      // ----- UI UPDATE & LOGIC -----
      function updateSummary() {
        if (!state.selectedPack) return;
        const pack = PACKS[state.selectedPack];
        const subtotal = pack.price;
        const sst = subtotal * SST_RATE;
        const grandTotal = subtotal + sst;
        
        $('#sum-pack').textContent = pack.label;
        $('#sum-tokens').textContent = pack.tokens;
        $('#sum-subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
        $('#sum-sst').textContent = `RM ${sst.toFixed(2)}`;
        $('#sum-grand').textContent = `RM ${grandTotal.toFixed(2)}`;
      }

      function updateStepperUI() {
        stepNavs.forEach((nav, index) => {
          const stepNum = index + 1;
          const circle = nav.querySelector('div');
          const text = nav.querySelector('div.mt-3');
          
          circle.classList.remove('bg-primary', 'border-primary', 'text-white', 'bg-teal-600', 'border-teal-600', 'border-gray-300');
          text.classList.remove('text-primary', 'text-gray-500');

          if (stepNum < state.currentStep) {
            circle.classList.add('bg-teal-600', 'border-teal-600', 'text-white');
            text.classList.add('text-primary');
            circle.innerHTML = '<i class="ri-check-line font-bold text-lg"></i>';
          } else if (stepNum === state.currentStep) {
            circle.classList.add('bg-primary', 'border-primary', 'text-white');
            text.classList.add('text-primary');
            circle.innerHTML = `<span class="font-bold text-lg">${stepNum}</span>`;
          } else {
            circle.classList.add('border-gray-300');
            text.classList.add('text-gray-500');
            circle.innerHTML = `<span class="font-bold text-lg">${stepNum}</span>`;
          }
        });
        
        $('.flex-auto.border-t-2').classList.remove('border-primary', 'border-gray-300', 'dark:border-gray-600');
        if (state.currentStep > 1) {
          $('.flex-auto.border-t-2').classList.add('border-primary');
        } else {
          $('.flex-auto.border-t-2').classList.add('border-gray-300', 'dark:border-gray-600');
        }
      }

      function updateButtonVisibility() {
        btnPrev.classList.toggle('hidden', state.currentStep === 1);
        btnNext.classList.toggle('hidden', state.currentStep === 2);
        // DIPERBAIKI: Sembunyikan butang submit jika kaedah bayaran ialah 'duitnow'
        btnSubmit.classList.toggle('hidden', state.currentStep !== 2 || state.paymentMethod === 'duitnow');
      }

      function generateQRCode() {
        const qrContainer = document.getElementById('qr-code-container');
        if (qrContainer) {
          qrContainer.innerHTML = '';
          new QRCode(qrContainer, {
            text: "http://bank-abc.com/payment.html?akaun=123",
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        }
      }

      function renderPaymentPanel() {
        const container = $('#step-2');
        const existingPanel = container.querySelector('.payment-method-panel');
        if (existingPanel) existingPanel.remove();

        let panelHtml = '';
        if (state.paymentMethod === 'fpx') {
          panelHtml = `
            <div class="payment-method-panel mt-6">
              <label for="fpx-bank" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Choose your bank <span class="text-red-500">*</span></label>
              <select id="fpx-bank" class="w-full mt-1 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">-- Select Bank --</option>
                <option>Maybank</option><option>CIMB Bank</option><option>Public Bank</option><option>RHB Bank</option><option>Hong Leong Bank</option><option>Bank Islam</option><option>AmBank</option>
              </select>
            </div>`;
        } else if (state.paymentMethod === 'card') {
          panelHtml = `
            <div class="payment-method-panel mt-6 space-y-4">
               <div>
                 <label for="cc-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name on Card <span class="text-red-500">*</span></label>
                 <input id="cc-name" type="text" autocomplete="cc-name" placeholder="JOHN A DOE" class="mt-1 w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
               </div>
               <div>
                 <label for="cc-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Number <span class="text-red-500">*</span></label>
                 <input id="cc-number" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="4242 4242 4242 4242" class="mt-1 w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
               </div>
               <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="cc-exp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expiry (MM/YY) <span class="text-red-500">*</span></label>
                    <input id="cc-exp" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" class="mt-1 w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                  </div>
                  <div>
                    <label for="cc-cvv" class="block text-sm font-medium text-gray-700 dark:text-gray-300">CVV/CVC <span class="text-red-500">*</span></label>
                    <input id="cc-cvv" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="123" class="mt-1 w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="cc-country" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Country <span class="text-red-500">*</span></label>
                        <select id="cc-country" class="w-full mt-1 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Select Country</option>
                            <option>Malaysia</option><option>Singapore</option><option>United States</option>
                        </select>
                    </div>
                    <div>
                        <label for="cc-postal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Postal / ZIP Code <span class="text-red-500">*</span></label>
                        <input id="cc-postal" type="text" inputmode="numeric" placeholder="e.g. 50480" class="mt-1 w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>
            </div>`;
        } else if (state.paymentMethod === 'duitnow') {
          panelHtml = `
            <div class="payment-method-panel mt-6 text-center">
              <div id="qr-code-container" class="bg-white p-4 rounded-md shadow w-[288px] h-[288px] inline-flex items-center justify-center"></div>
              <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">Scan using your banking app to complete payment.</p>
            </div>`;
        }
        container.insertAdjacentHTML('beforeend', panelHtml);
        if(state.paymentMethod === 'duitnow') generateQRCode();
        addPaymentInputListeners();
      }

      function validateCurrentStep() {
        const step = state.currentStep;
        let isValid = false;
        if (step === 1) {
          isValid = !!state.selectedPack;
        } else if (step === 2) {
          if (state.paymentMethod === 'fpx') {
            isValid = $('#fpx-bank')?.value !== '';
          } else if (state.paymentMethod === 'card') {
            isValid = $('#cc-name')?.value && $('#cc-number')?.value && $('#cc-exp')?.value && $('#cc-cvv')?.value && $('#cc-country')?.value && $('#cc-postal')?.value;
          } else if (state.paymentMethod === 'duitnow') {
            isValid = true; // QR Code step is always "valid" to proceed.
          }
        }
        state.isStepValid[step - 1] = isValid;
        if(step === 1) btnNext.disabled = !isValid;
        if(step === 2) btnSubmit.disabled = !isValid;
      }
      
      function goToStep(stepNumber) {
        state.currentStep = stepNumber;
        stepPanels.forEach((panel, index) => {
          panel.classList.toggle('hidden', index + 1 !== state.currentStep);
        });
        updateStepperUI();
        updateButtonVisibility();
        validateCurrentStep();
      }

      function addPaymentInputListeners() {
        if(state.paymentMethod === 'fpx') {
          $('#fpx-bank')?.addEventListener('change', validateCurrentStep);
        } else if (state.paymentMethod === 'card') {
          $$('#step-2 input, #step-2 select').forEach(input => input.addEventListener('input', validateCurrentStep));
        }
      }

      $$('input[name="pack"]').forEach(radio => radio.addEventListener('change', (e) => {
        state.selectedPack = e.target.value;
        updateSummary();
        validateCurrentStep();
      }));
      
      $$('input[name="paymethod"]').forEach(radio => radio.addEventListener('change', (e) => {
        state.paymentMethod = e.target.value;
        renderPaymentPanel();
        validateCurrentStep();
        updateButtonVisibility(); // Panggil fungsi ini untuk mengemas kini butang serta-merta
      }));
      
      btnNext.addEventListener('click', () => { if (state.currentStep < 2) goToStep(state.currentStep + 1); });
      btnPrev.addEventListener('click', () => { if (state.currentStep > 1) goToStep(state.currentStep - 1); });
      
      form.addEventListener('submit', (e) => {
          e.preventDefault();
          if (state.paymentMethod === 'duitnow') return; // Jangan submit jika DuitNow
          validateCurrentStep();
          if(!state.isStepValid[1]) { return; }
          btnSubmit.disabled = true;
          btnSubmit.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i> Redirecting...';
          console.log('Submitting data:', {
              pack: state.selectedPack,
              paymentMethod: state.paymentMethod,
          });
          setTimeout(() => {
              alert('Redirecting to payment gateway!');
              btnSubmit.disabled = false;
              btnSubmit.innerHTML = '<i class="ri-shield-check-line text-lg"></i><span>Proceed to Payment</span>';
          }, 1500);
      });

      function initialize() {
          const defaultPack = $('input[name="pack"][value="rm100"]');
          if (defaultPack) {
              defaultPack.checked = true;
              state.selectedPack = 'rm100';
          }
          updateSummary();
          renderPaymentPanel();
          goToStep(1);
      }
      initialize();
    })();
</script>
</body>
</html>