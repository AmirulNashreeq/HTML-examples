<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Find Certificate - MySertifico</title>
  <link rel="icon" type="image/png" href="../../src/images/logos/favicon.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';"/>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Remix Icon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&family=EB+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet"/>
  <!-- QRCode.js (davidshimjs) -->
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <!-- jsPDF and html2canvas for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            poppins: ['Poppins', 'sans-serif'],
            garamond: ['EB Garamond', 'serif'],
            montserrat: ['Montserrat', 'sans-serif'],
          },
          colors: {
            primary: { DEFAULT: '#0d9488', dark: '#0f766e', light: '#ccfbf1' },
            accent:  { DEFAULT: '#f59e0b', hover: '#d97706' },
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    .preview-element { position: absolute; white-space: normal; word-break: break-word; overflow-wrap: anywhere; z-index: 10; }
    /* util untuk state aktif nav */
    .nav-active { background-color: #0f766e; color:#fff !important; box-shadow: 0 1px 2px rgb(0 0 0 / .1); }
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d9488;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
<!-- ===== Sidebar Start ===== -->
<aside id="sidebar" class="sidebar fixed top-0 left-0 z-50 h-full w-64 bg-gray-800 dark:bg-gray-950 text-white transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
    <div class="flex items-center justify-between p-6">
      <h2 class="font-poppins text-2xl font-bold text-white">Menu</h2>
      <button id="close-sidebar" class="text-gray-400 hover:text-white">
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>
    <nav class="p-4">
      <ul class="space-y-2">
        <li>
          <a href="dashboard.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors" data-route="dashboard.html">
            <i class="ri-dashboard-3-line mr-3 text-lg"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <button data-collapse-toggle="submenu-gallery" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
            <span class="flex items-center"><i class="ri-gallery-line mr-3 text-lg"></i><span>Gallery</span></span>
            <i class="ri-arrow-down-s-line transition-transform duration-200"></i>
          </button>
          <ul id="submenu-gallery" class="hidden py-2 space-y-1 pl-8">
            <li><a href="templates-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="templates-list.html">Templates</a></li>
            <li><a href="logos-badges.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="logos-badges.html">Logos & Badges</a></li>
          </ul>
        </li>
        <li>
          <a href="certificate-list.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors" data-route="certificate-list.html">
            <i class="ri-award-line mr-3 text-lg"></i>
            <span>Certificates</span>
          </a>
        </li>
         <li>
            <a href="find-certificate.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors" data-route="find-certificate.html">
                <i class="ri-user-search-line mr-3 text-lg"></i>
                <span>Find Certificate</span>
            </a>
        </li>
        <li>
          <button data-collapse-toggle="submenu-settings" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
            <span class="flex items-center"><i class="ri-settings-3-line mr-3 text-lg"></i><span>Settings</span></span>
            <i class="ri-arrow-down-s-line transition-transform duration-200"></i>
          </button>
          <ul id="submenu-settings" class="hidden py-2 space-y-1 pl-8">
            <li><a href="organisation.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="organisation.html">Organisation</a></li>
            <li><a href="logo-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="logo-list.html">Logos</a></li>
            <li><a href="selected-template-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="selected-template-list.html">Selected Templates</a></li>
            <li><a href="user-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="user-list.html">Users</a></li>
            <li class="px-4"><hr class="border-gray-700 my-1"></li>
            <li><a href="account.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700" data-route="account.html">Account</a></li>
          </ul>
        </li>
        <li class="pt-4 mt-4 border-t border-gray-700">
          <a href="#" id="logout-sidebar" class="flex items-center py-2.5 px-4 rounded-lg text-red-400 hover:bg-red-500 hover:text-white transition-colors">
            <i class="ri-logout-box-r-line mr-3 text-lg"></i>
            <span>Log Out</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
  <!-- ===== Main ===== -->
  <div id="main-content" class="relative min-h-screen transition-all duration-300 ease-in-out">
    <!-- Navbar -->
    <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center space-x-4">
            <button id="sidebar-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-menu-line text-2xl"></i></button>
            <a href="dashboard.html" class="flex items-center gap-x-2">
                <img src="../../src/images/logos/logo.png" alt="MySertifico Logo" class="h-8 w-8 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';">
                <span class="font-poppins text-2xl font-bold text-primary hidden sm:block">MySertifico</span>
            </a>
            </div>
            <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-moon-line block dark:hidden"></i><i class="ri-sun-line hidden dark:block"></i></button>
            <div class="relative">
                <button id="profile-menu-button" class="flex items-center space-x-2">
                <img class="h-9 w-9 rounded-full object-cover" src="https://i.pravatar.cc/150?u=admin" alt="Admin" onerror="this.onerror=null;this.src='https://placehold.co/40x40/0d9488/ffffff?text=A';">
                <div class="hidden md:block text-left">
                    <div class="text-sm font-semibold text-gray-800 dark:text-white">Fikri Nabil</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Super Admin</div>
                </div>
                </button>
                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5">
                <div class="py-1">
                    <a href="my-profile.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-user-line mr-3"></i>My Profile</a>
                    <a href="change-password.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-lock-password-line mr-3"></i>Change Password</a>
                    <hr class="border-gray-200 dark:border-gray-700 my-1">
                    <a href="#" id="logout-navbar" class="flex items-center w-full px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-logout-box-r-line mr-3"></i>Logout</a>
                </div>
                </div>
            </div>
            </div>
        </div>
    </header>
    <!-- Page -->
    <main class="p-6 sm:p-8">
      <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Find Certificate</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Search for a recipient's certificate using their National ID.</p>
          </div>
        </div>
        
        <!-- Search Form -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-6">
            <div class="flex flex-col sm:flex-row items-end gap-4">
                <div class="w-full sm:flex-grow">
                    <label for="national-id-input" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">National ID</label>
                    <input type="text" id="national-id-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="e.g., 900101105555" required>
                    <p id="validation-error" class="hidden mt-2 text-sm text-red-600 dark:text-red-500"><span class="font-medium">Oops!</span> National ID cannot be empty.</p>
                </div>
                <button id="search-button" class="w-full sm:w-auto justify-center text-white bg-primary hover:bg-primary-dark focus:ring-4 focus:outline-none focus:ring-primary/50 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center">
                    <i class="ri-search-line mr-2 -ml-1"></i>
                    Search
                </button>
            </div>
        </div>

        <!-- Search Results Section -->
        <div id="results-section" class="hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Certificates for <span id="recipient-name"></span></h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Found <span id="certificate-count">0</span> certificate(s).</p>
                    </div>
                    <div class="relative w-full md:w-72">
                        <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="certificate-search-input" placeholder="Search certificate name..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"/>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-6 py-3 w-12">#</th>
                                <th scope="col" class="px-6 py-3">Certificate Name</th>
                                <th scope="col" class="px-6 py-3">Issued Date</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                           <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
                 <p id="no-filtered-results" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">No certificates match your search.</p>
            </div>
        </div>

        <!-- Not Found Message -->
        <div id="not-found-message" class="hidden text-center py-16">
          <i class="ri-user-unfollow-line text-6xl text-gray-400 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">recipient Not Found</h3>
          <p class="text-gray-500 dark:text-gray-400 mt-1">The National ID you entered does not match any records in our database.</p>
        </div>
      </div>
    </main>
  </div>
  <!-- Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 bg-black/70 z-[120] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div id="preview-modal-panel" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl transform transition-all opacity-0 scale-95 flex flex-col max-h-[92vh]">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 id="preview-modal-title" class="font-poppins font-bold text-lg text-gray-800 dark:text-white">Certificate Preview</h3>
        <button type="button" id="close-preview-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i class="ri-close-line text-2xl"></i></button>
      </div>
      <div class="p-6 flex-grow overflow-auto bg-gray-100 dark:bg-gray-900">
        <div class="flex items-center justify-center">
          <div id="preview-container" class="relative shadow-lg w-full max-w-[900px]">
            <img id="preview-blanko" src="" class="w-full h-auto" alt="Template Background"/>
            <div id="preview-elements" class="absolute inset-0"></div>
          </div>
        </div>
      </div>
      <div id="modal-footer-content" class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-700 gap-x-3">
        <button type="button" id="download-pdf-btn" class="px-4 py-2 text-sm bg-primary text-white rounded-lg hover:bg-primary-dark inline-flex items-center gap-2">
            <i class="ri-download-2-line"></i>
            <span>Download PDF</span>
        </button>
        <button type="button" id="close-preview-modal-footer" class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
      </div>
      <div id="modal-footer-loading" class="hidden flex items-center justify-center p-4 border-t border-gray-200 dark:border-gray-700 gap-x-3">
        <div class="loader"></div>
        <span class="text-gray-600 dark:text-gray-300">Generating PDF, please wait...</span>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { jsPDF } = window.jspdf;

      /* ===== Shell/UI basics ===== */
      const sidebar = document.getElementById('sidebar');
      const sidebarToggleBtn = document.getElementById('sidebar-toggle');
      const closeSidebarBtn = document.getElementById('close-sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const openSidebar = () => { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
      const closeSidebar = () => { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
      sidebarToggleBtn.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
      closeSidebarBtn.addEventListener('click', closeSidebar);
      overlay.addEventListener('click', closeSidebar);
      const themeToggleBtn = document.getElementById('theme-toggle');
      const applyTheme = () => {
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else { document.documentElement.classList.remove('dark'); }
      };
      applyTheme();
      themeToggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
      });
      const profileMenuButton = document.getElementById('profile-menu-button');
      const profileMenu = document.getElementById('profile-menu');
      profileMenuButton?.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('hidden'); });
      window.addEventListener('click', (e) => {
        if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenuButton.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.classList.add('hidden');
      });
      const logout = () => { window.location.href = "../landing/home.html"; };
      document.getElementById('logout-sidebar').addEventListener('click', e => { e.preventDefault(); logout(); });
      document.getElementById('logout-navbar').addEventListener('click', e => { e.preventDefault(); logout(); });
      
      /* ====== Sidebar memory (sync with Dashboard) ====== */
      const NAV_KEY = 'mys_sidebar_memory';
      const getFile = (href) => (href || '').split('/').pop();
      const currentFile = getFile(window.location.pathname) || 'find-certificate.html';
      function saveNavState(state){
        try { localStorage.setItem(NAV_KEY, JSON.stringify(state)); } catch(e){}
      }
      function readNavState(){
        try { return JSON.parse(localStorage.getItem(NAV_KEY) || '{}'); } catch(e){ return {}; }
      }
      function restoreSidebar(){
        const state = readNavState();
        document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
          const targetId = btn.getAttribute('data-collapse-toggle');
          const ul = document.getElementById(targetId);
          const arrow = btn.querySelector('.ri-arrow-down-s-line');
          const open = state.open?.[targetId] ?? false;
          if (ul){
            ul.classList.toggle('hidden', !open);
            if (arrow) arrow.classList.toggle('rotate-180', open);
            if (open) { btn.classList.add('bg-gray-700','text-white'); }
          }
        });
        const activeRoute = state.active || currentFile;
        setActiveLink(activeRoute);
      }
      function setActiveLink(routeFile){
        document.querySelectorAll('nav a[data-route]').forEach(a => a.classList.remove('nav-active', 'text-white'));
        const target = Array.from(document.querySelectorAll('nav a[data-route]')).find(a => a.dataset.route === routeFile);
        if (target){
          target.classList.add('nav-active');
          const parentUl = target.closest('ul[id^="submenu-"]');
          if (parentUl){
            const btn = document.querySelector(`[data-collapse-toggle="${parentUl.id}"]`);
            const arrow = btn?.querySelector('.ri-arrow-down-s-line');
            parentUl.classList.remove('hidden');
            btn?.classList.add('bg-gray-700','text-white');
            arrow?.classList.add('rotate-180');
          }
          const state = readNavState();
          state.active = routeFile;
          state.open = state.open || {};
          document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
            const id = btn.getAttribute('data-collapse-toggle');
            state.open[id] = !document.getElementById(id)?.classList.contains('hidden');
          });
          saveNavState(state);
        }
      }
      document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-collapse-toggle');
          document.getElementById(id)?.classList.toggle('hidden');
          btn.querySelector('.ri-arrow-down-s-line')?.classList.toggle('rotate-180');
          btn.classList.toggle('bg-gray-700');
          btn.classList.toggle('text-white');
          const state = readNavState();
          state.open = state.open || {};
          state.open[id] = !document.getElementById(id)?.classList.contains('hidden');
          saveNavState(state);
        });
      });
      document.querySelectorAll('nav a[data-route]').forEach(a => {
        a.addEventListener('click', (e) => {
            // e.preventDefault(); // Hentikan navigasi biasa
            setActiveLink(a.dataset.route);
            // window.location.href = a.href; // Lakukan navigasi selepas state disimpan
        });
      });

      restoreSidebar();
      setActiveLink('find-certificate.html');

      /* ===== Data Constants & Helpers ===== */
      const DPI = 96;
      const CM_TO_PX = DPI / 2.54;
      const MARGIN_PX = 2.0 * CM_TO_PX;
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const PORTRAIT_W = 794, PORTRAIT_H = 1123;
      const LAND_W = 1123, LAND_H = 794;

      // This is the same template data from the other page
      const templatesData = [
          { id: 1, template_code:'MDPL-GREEN-001',  style:'Modern',  orientation:'Portrait',  alignment:'Left',   theme_color:'Green',  imageUrl:'../../src/images/templates/mdpl-green-001.svg',  original_width:PORTRAIT_W, original_height:PORTRAIT_H },
          { id: 2, template_code:'MDPC-GOLD-002',   style:'Modern',  orientation:'Portrait',  alignment:'Center', theme_color:'Gold',   imageUrl:'../../src/images/templates/clpc-gold-010.svg',  original_width:PORTRAIT_W, original_height:PORTRAIT_H },
          { id: 4, template_code:'CLLL-RED-004',    style:'Classic', orientation:'Landscape', alignment:'Left',   theme_color:'Red',    imageUrl:'../../src/images/templates/clll-red-004.svg',   original_width:LAND_W, original_height:LAND_H },
      ];
      
      const elementsData = {
          'MDPL-GREEN-001': [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:120, position_y:150, width:120, height:120 }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:120, position_y:230, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:120, position_y:255, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:120, position_y:275, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"certificate_title", type:"text", content:"{Certificate_Title}", position_x:120, position_y:360, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" }, { element_id:"certificate_body", type:"text", content:"{Certificate_Body}", position_x:120, position_y:450, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:120, position_y:500, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" }, { element_id:"event_description", type:"text", content:"{Event_Description}", position_x:120, position_y:540, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:120, position_y:565, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" }, { element_id:"signature_image", type:"image", content:"{Signature_Image}", position_x:120, position_y:820, width:200, height:150 }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:120, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:120, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:120, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151" }, { element_id:"qr_code", type:"qrcode", content:"{QR_Code}", position_x:560, position_y:860, width:120, height:120 } ],
          'MDPC-GOLD-002': [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:397, position_y:150, width:120, height:120 }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:397, position_y:230, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:397, position_y:255, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:397, position_y:275, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"certificate_title", type:"text", content:"{Certificate_Title}", position_x:397, position_y:360, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" }, { element_id:"certificate_body", type:"text", content:"{Certificate_Body}", position_x:397, position_y:440, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:397, position_y:485, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" }, { element_id:"event_description", type:"text", content:"{Event_Description}", position_x:397, position_y:525, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:397, position_y:550, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" }, { element_id:"signature_image", type:"image", content:"{Signature_Image}", position_x:260, position_y:820, width:200, height:150 }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:260, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:260, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:260, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151" }, { element_id:"qr_code", type:"qrcode", content:"{QR_Code}", position_x:560, position_y:860, width:120, height:120 } ],
          'CLLL-RED-004': [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:100, position_y:150, width:120, height:120 }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:100, position_y:220, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:100, position_y:240, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:100, position_y:260, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"certificate_title", type:"text", content:"{Certificate_Title}", position_x:100, position_y:320, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29" }, { element_id:"certificate_body", type:"text", content:"{Certificate_Body}", position_x:100, position_y:390, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:100, position_y:430, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000" }, { element_id:"event_description", type:"text", content:"{Event_Description}", position_x:100, position_y:465, font_family:"Montserrat", font_size:16, color:"#374151" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:100, position_y:490, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827" }, { element_id:"signature_image", type:"image", content:"{Signature_Image}", position_x:100, position_y:590, width:200, height:150 }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:100, position_y:630, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:100, position_y:650, font_family:"Montserrat", font_size:14, color:"#374151" }, { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:100, position_y:700, font_family:"Montserrat", font_size:12, color:"#374151" }, { element_id:"qr_code", type:"qrcode", content:"{QR_Code}", position_x:900, position_y:590, width:120, height:120 } ]
      };
      
      // Mock recipient database
      const recipientDatabase = {
        "900101105555": {
            name: "Siti Nurhaliza binti Tarudin",
            certificates: [
                {
                    id: 'cert-001',
                    name: "Sijil Tamat Sekolah Kohort 2021 - 2025",
                    issuedDate: "25/12/2025",
                    status: "Published",
                    template_code: 'MDPL-GREEN-001',
                    data: {
                        Organization_Name: "SMK Puchong Perdana",
                        Address_row1: "Jalan Perdana 2/1, Taman Puchong Perdana",
                        Address_row2: "47100 Puchong, Selangor",
                        Certificate_Title: "SIJIL TAMAT SEKOLAH",
                        Certificate_Body: "Dengan ini disahkan bahawa",
                        Recipient_Name: "Siti Nurhaliza binti Tarudin",
                        Event_Description: "telah menamatkan pengajian Tingkatan 5 dengan jayanya.",
                        Event_Date: "25 Disember 2025",
                        Signature_Image: "../../src/images/signatures/sample-signature.png",
                        Signatory_Name: "En. Ahmad Kamal",
                        Signatory_Position: "Pengetua Sekolah",
                        Signed_Date: "25/12/2025",
                        QR_Code: "https://des.mysertifico.com/verify.html?id=graduasi-2025-900101105555"
                    }
                },
                {
                    id: 'cert-002',
                    name: "Anugerah Pelajar Cemerlang SPM 2025",
                    issuedDate: "15/03/2026",
                    status: "Published",
                    template_code: 'CLLL-RED-004',
                    data: {
                        Organization_Name: "SMK Puchong Perdana",
                        Address_row1: "Jalan Perdana 2/1, Taman Puchong Perdana",
                        Address_row2: "47100 Puchong, Selangor",
                        Certificate_Title: "ANUGERAH CEMERLANG",
                        Certificate_Body: "Dianugerahkan kepada",
                        Recipient_Name: "Siti Nurhaliza binti Tarudin",
                        Event_Description: "di atas pencapaian cemerlang 9A+ dalam Sijil Pelajaran Malaysia 2025.",
                        Event_Date: "15 Mac 2026",
                        Signature_Image: "../../src/images/signatures/sample-signature.png",
                        Signatory_Name: "En. Ahmad Kamal",
                        Signatory_Position: "Pengetua Sekolah",
                        Signed_Date: "15/03/2026",
                        QR_Code: "https://des.mysertifico.com/verify.html?id=spm-2025-900101105555"
                    }
                }
            ]
        },
        "051120081234": {
            name: "Lee Chong Wei",
            certificates: [
                 {
                    id: 'cert-003',
                    name: "Sijil Kehadiran Penuh 2024",
                    issuedDate: "10/12/2024",
                    status: "Published",
                    template_code: 'MDPC-GOLD-002',
                    data: {
                        Organization_Name: "SMK Puchong Perdana",
                        Address_row1: "Jalan Perdana 2/1, Taman Puchong Perdana",
                        Address_row2: "47100 Puchong, Selangor",
                        Certificate_Title: "SIJIL KEHADIRAN PENUH",
                        Certificate_Body: "Dengan sukacitanya dimaklumkan bahawa",
                        Recipient_Name: "Lee Chong Wei",
                        Event_Description: "telah mencapai kehadiran 100% bagi sesi persekolahan tahun 2024.",
                        Event_Date: "10 Disember 2024",
                        Signature_Image: "../../src/images/signatures/sample-signature.png",
                        Signatory_Name: "En. Ahmad Kamal",
                        Signatory_Position: "Pengetua Sekolah",
                        Signed_Date: "10/12/2024",
                        QR_Code: "https://des.mysertifico.com/verify.html?id=penuh-2024-051120081234"
                    }
                }
            ]
        }
      };
      
      let currentrecipientCertificates = [];

      /* ===== DOM Elements ===== */
      const nationalIdInput = document.getElementById('national-id-input');
      const searchButton = document.getElementById('search-button');
      const validationError = document.getElementById('validation-error');
      const resultsSection = document.getElementById('results-section');
      const notFoundMessage = document.getElementById('not-found-message');
      const recipientNameSpan = document.getElementById('recipient-name');
      const certificateCountSpan = document.getElementById('certificate-count');
      const resultsTableBody = document.getElementById('results-table-body');
      const certificateSearchInput = document.getElementById('certificate-search-input');
      const noFilteredResults = document.getElementById('no-filtered-results');

      /* ===== Search Logic ===== */
      searchButton.addEventListener('click', () => {
        const nationalId = nationalIdInput.value.trim();
        
        // Reset UI
        validationError.classList.add('hidden');
        resultsSection.classList.add('hidden');
        notFoundMessage.classList.add('hidden');

        if (!nationalId) {
            validationError.classList.remove('hidden');
            return;
        }

        const recipientData = recipientDatabase[nationalId];

        if (recipientData) {
            currentrecipientCertificates = recipientData.certificates;
            displayResults(recipientData);
        } else {
            notFoundMessage.classList.remove('hidden');
        }
      });
      
      /* ===== Results Display Logic ===== */
      function displayResults(recipientData) {
        recipientNameSpan.textContent = recipientData.name;
        certificateCountSpan.textContent = recipientData.certificates.length;
        renderTable(recipientData.certificates);
        resultsSection.classList.remove('hidden');
      }

      function renderTable(certificates) {
        resultsTableBody.innerHTML = '';
        noFilteredResults.classList.toggle('hidden', certificates.length > 0);
        
        if (certificates.length === 0) return;
        
        certificates.forEach((cert, index) => {
            const row = `
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${index + 1}.</td>
                    <td class="px-6 py-4">${cert.name}</td>
                    <td class="px-6 py-4">${cert.issuedDate}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300">${cert.status}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button class="view-btn text-primary dark:text-primary-light hover:underline" data-cert-id="${cert.id}">
                            <i class="ri-eye-line text-lg"></i>
                        </button>
                    </td>
                </tr>
            `;
            resultsTableBody.insertAdjacentHTML('beforeend', row);
        });
      }

      certificateSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filteredCerts = currentrecipientCertificates.filter(cert => 
              cert.name.toLowerCase().includes(searchTerm)
          );
          renderTable(filteredCerts);
      });

      resultsTableBody.addEventListener('click', (e) => {
          const viewButton = e.target.closest('.view-btn');
          if (viewButton) {
              const certId = viewButton.dataset.certId;
              const certificate = currentrecipientCertificates.find(c => c.id === certId);
              if (certificate) {
                  openPreviewModal(certificate);
              }
          }
      });

      /* ===== Preview Modal Logic ===== */
      const previewModal = document.getElementById('preview-modal');
      const previewModalPanel = document.getElementById('preview-modal-panel');
      const previewModalTitle = document.getElementById('preview-modal-title');
      const previewContainer = document.getElementById('preview-container');
      const previewBlanko = document.getElementById('preview-blanko');
      const previewElements = document.getElementById('preview-elements');
      const downloadPdfBtn = document.getElementById('download-pdf-btn');

      function openPreviewModal(certificate) {
          const baseTemplate = templatesData.find(t => t.template_code === certificate.template_code);
          if (!baseTemplate) {
              console.error("Base template not found for code:", certificate.template_code);
              return;
          }

          const templateWithElements = {
              ...baseTemplate,
              content: elementsData[certificate.template_code] || []
          };
          
          previewModalTitle.textContent = `Preview: ${certificate.name}`;
          previewBlanko.src = templateWithElements.imageUrl;
          previewContainer.style.aspectRatio = `${templateWithElements.original_width} / ${templateWithElements.original_height}`;
          previewContainer.style.maxWidth = templateWithElements.orientation === 'Portrait' ? '520px' : '900px';
          
          // Attach certificate data to the download button
          downloadPdfBtn.dataset.certificateData = JSON.stringify(certificate);
          
          previewElements.innerHTML = '';
          
          previewModal.classList.remove('hidden');
          previewModal.classList.add('flex');
          
          setTimeout(() => {
              const rect = previewContainer.getBoundingClientRect();
              const scale = rect.width / templateWithElements.original_width;
              previewElements.innerHTML = generateOverlayElements(templateWithElements, scale, certificate.data);
              renderQRCodesIn(previewElements);
              previewModalPanel.classList.remove('opacity-0', 'scale-95');
          }, 50);
      }

      function closePreviewModal() {
        previewModalPanel.classList.add('opacity-0','scale-95');
        setTimeout(() => { previewModal.classList.add('hidden'); previewModal.classList.remove('flex'); }, 300);
      }
      
      document.getElementById('close-preview-modal').addEventListener('click', closePreviewModal);
      document.getElementById('close-preview-modal-footer').addEventListener('click', closePreviewModal);
      previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closePreviewModal(); });


      function xAnchorStyle(template, xPx){
        const w = template.original_width;
        if (template.alignment === 'Left'){
          return { xStyle: `left:${(xPx / w) * 100}%;`, transform: 'translateY(-50%)', textAlign: 'left' };
        }
        if (template.alignment === 'Right'){
          return { xStyle: `right:${((w - xPx) / w) * 100}%;`, transform: 'translateY(-50%)', textAlign: 'right' };
        }
        return { xStyle: `left:${(xPx / w) * 100}%;`, transform: 'translate(-50%, -50%)', textAlign: 'center' };
      }

      function generateOverlayElements(template, scaleFactor, data) {
          const contentWidth  = template.original_width  - 2 * MARGIN_PX;
          return template.content.map(el => {
            const safeY = clamp(el.position_y, MARGIN_PX, template.original_height - MARGIN_PX);
            const topPercent = (safeY / template.original_height) * 100;
            const { xStyle, transform, textAlign } = xAnchorStyle(template, el.position_x);
            
            let finalContent = el.content;
            if (data) {
                finalContent = finalContent.replace(/{(\w+)}/g, (match, key) => data[key] || match);
            }

            let baseStyle = `top:${topPercent}%;${xStyle}transform:${transform};`;
            
            if (el.type === 'text'){
              const fs = el.font_size || 14, lh = fs * 1.2;
              const wPx = Math.min(contentWidth, (template.orientation === 'Portrait' ? 520 : 720));
              baseStyle += `font-family:'${el.font_family || 'Montserrat'}',sans-serif;` +
                           `font-size:${fs * scaleFactor}px;` +
                           `line-height:${lh * scaleFactor}px;` +
                           `font-weight:${el.font_weight || 'normal'};` +
                           `color:${el.color || '#111827'};` +
                           `text-align:${textAlign};` +
                           `max-width:${wPx * scaleFactor}px;`;
              return `<div class="preview-element" style="${baseStyle}">${finalContent}</div>`;
            }
            if (el.type === 'image'){
              const w = (el.width  || 120) * scaleFactor;
              const h = (el.height || 120) * scaleFactor;
              baseStyle += `width:${w}px;height:${h}px;`;
              return `<img class="preview-element" src="${finalContent}" style="${baseStyle}" alt="${el.element_id}" onerror="this.style.display='none'">`;
            }
            if (el.type === 'qrcode'){
              const w = (el.width  || 100) * scaleFactor;
              const h = (el.height || w)   * scaleFactor;
              baseStyle += `width:${w}px;height:${h}px;`;
              return `<div class="preview-element qr-holder" data-text="${finalContent}" style="${baseStyle}"></div>`;
            }
            return '';
          }).join('');
      }

      function renderQRCodesIn(container){
        const holders = container.querySelectorAll('.qr-holder');
        holders.forEach(holder => {
          const text = holder.dataset.text || '';
          const width  = parseFloat(holder.style.width)  || 100;
          const height = parseFloat(holder.style.height) || width;
          holder.innerHTML = '';
          if (!text) return;
          try {
            new QRCode(holder, { text, width, height, colorDark : "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
          } catch(e) {
            console.error("QR Code generation failed:", e);
            holder.innerHTML = "QR Error";
          }
        });
      }

      /* ===== PDF Download Logic ===== */
        const modalFooterContent = document.getElementById('modal-footer-content');
        const modalFooterLoading = document.getElementById('modal-footer-loading');

        downloadPdfBtn.addEventListener('click', async () => {
            const certificate = JSON.parse(downloadPdfBtn.dataset.certificateData);
            const baseTemplate = templatesData.find(t => t.template_code === certificate.template_code);

            if (!certificate || !baseTemplate) {
                alert('Error: Could not find certificate data to generate PDF.');
                return;
            }
            
            modalFooterContent.classList.add('hidden');
            modalFooterLoading.classList.remove('hidden');

            try {
                // Use a higher scale for better quality
                const canvas = await html2canvas(previewContainer, { scale: 3, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                
                const orientation = baseTemplate.orientation.toLowerCase();
                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'px',
                    format: [baseTemplate.original_width, baseTemplate.original_height]
                });

                pdf.addImage(imgData, 'PNG', 0, 0, baseTemplate.original_width, baseTemplate.original_height);
                
                const fileName = `${certificate.name.replace(/\s+/g, '_')}_${certificate.data.Recipient_Name.replace(/\s+/g, '_')}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Sorry, there was an error generating the PDF. Please try again.');
            } finally {
                modalFooterContent.classList.remove('hidden');
                modalFooterLoading.classList.add('hidden');
            }
        });

    });
  </script>
</body>
</html>
