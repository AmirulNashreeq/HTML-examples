<!DOCTYPE html>
<html lang="en" class="">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Recipient - MySertifico</title>
  <link rel="icon" type="image/png" href="../../src/images/logos/favicon.png"
    onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';">

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&family=Montserrat:wght@400;500;600;700&family=EB+Garamond:wght@400;700&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            poppins: ['Poppins', 'sans-serif'],
            montserrat: ['Montserrat', 'sans-serif'],
            garamond: ['EB Garamond', 'serif'],
          },
          colors: {
            primary: { DEFAULT: '#0d9488', dark: '#0f766e', light: '#ccfbf1' },
            accent: { DEFAULT: '#f59e0b', hover: '#d97706' },
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    .preview-element{
      position:absolute; white-space:normal; word-break:break-word;
      overflow-wrap:anywhere; z-index:10; pointer-events:none;
    }
    .modal-enter { animation: fadeIn 0.3s ease-out; }
    .modal-leave { animation: fadeOut 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

  <aside id="sidebar" class="sidebar fixed top-0 left-0 z-50 h-full w-64 bg-gray-800 dark:bg-gray-950 text-white transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
    <div class="flex items-center justify-between p-6"><h2 class="font-poppins text-2xl font-bold text-white">Menu</h2><button id="close-sidebar" class="text-gray-400 hover:text-white"><i class="ri-close-line text-2xl"></i></button></div>
    <nav class="p-4">
        <ul class="space-y-2">
            <li><a href="dashboard.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white"><i class="ri-dashboard-3-line mr-3 text-lg"></i><span>Dashboard</span></a></li>
            <li><button data-collapse-toggle="submenu-gallery" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors"><span class="flex items-center"><i class="ri-gallery-line mr-3 text-lg"></i><span>Gallery</span></span><i class="ri-arrow-down-s-line transition-transform duration-200"></i></button><ul id="submenu-gallery" class="hidden py-2 space-y-1 pl-8"><li><a href="templates-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Templates</a></li><li><a href="logos-badges.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Logos & Badges</a></li></ul></li>
            <li><a href="certificate-list.html" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors"><i class="ri-award-line mr-3 text-lg"></i><span>Certificates</span></a></li>
            <li><button data-collapse-toggle="submenu-settings" type="button" class="w-full flex items-center justify-between py-2.5 px-4 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition-colors"><span class="flex items-center"><i class="ri-settings-3-line mr-3 text-lg"></i><span>Settings</span></span><i class="ri-arrow-down-s-line transition-transform duration-200"></i></button><ul id="submenu-settings" class="hidden py-2 space-y-1 pl-8"><li><a href="organisation.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Organisation</a></li><li><a href="logo-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Logos</a></li><li><a href="selected-template-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Selected Templates</a></li><li><a href="user-list.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Users</a></li><li class="px-4"><hr class="border-gray-700 my-1"></li><li><a href="account.html" class="block py-2 px-4 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-700">Account</a></li></ul></li>
            <li class="pt-4 mt-4 border-t border-gray-700"><a href="#" id="logout-sidebar" class="flex items-center py-2.5 px-4 rounded-lg text-red-400 hover:bg-red-500 hover:text-white transition-colors"><i class="ri-logout-box-r-line mr-3 text-lg"></i><span>Log Out</span></a></li>
        </ul>
    </nav>
  </aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
  <div id="main-content" class="relative min-h-screen transition-all duration-300 ease-in-out">
      <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between p-4">
              <div class="flex items-center space-x-4"><button id="sidebar-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none"><i class="ri-menu-line text-2xl"></i></button><a href="dashboard.html" class="flex items-center gap-x-2"><img src="../../src/images/logos/logo.png" alt="MySertifico Logo" class="h-8 w-8 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/32x32/0d9488/ffffff?text=M';"><span class="font-poppins text-2xl font-bold text-primary hidden sm:block">MySertifico</span></a></div>
              <div class="flex items-center space-x-4"><button id="theme-toggle" class="text-gray-600 dark:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-moon-line block dark:hidden"></i><i class="ri-sun-line hidden dark:block"></i></button><div class="relative"><button id="profile-menu-button" class="flex items-center space-x-2"><img class="h-9 w-9 rounded-full object-cover" src="https://i.pravatar.cc/150?u=admin" alt="Admin" onerror="this.onerror=null;this.src='https://placehold.co/40x40/0d9488/ffffff?text=A';"><div class="hidden md:block text-left"><div class="text-sm font-semibold text-gray-800 dark:text-white">Fikri Nabil</div><div class="text-xs text-gray-500 dark:text-gray-400">Super Admin</div></div></button><div id="profile-menu" class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"><div class="py-1"><a href="my-profile.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-user-line mr-3"></i>My Profile</a><a href="change-password.html" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-lock-password-line mr-3"></i>Change Password</a><hr class="border-gray-200 dark:border-gray-700 my-1"><a href="#" id="logout-navbar" class="flex items-center w-full px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="ri-logout-box-r-line mr-3"></i>Logout</a></div></div></div></div>
          </div>
      </header>
    
      <main class="p-6 sm:p-8">
          <div class="max-w-7xl mx-auto">
              <div id="page-header" class="mb-8">
                  <a href="dashboard.html" class="inline-flex items-center gap-2 text-primary hover:underline mb-2"><i class="ri-arrow-left-line"></i> Back to Dashboard</a>
                  <h1 id="recipient-name" class="text-3xl font-bold text-gray-800 dark:text-white">Loading...</h1>
                  <p id="recipient-id" class="text-gray-500 dark:text-gray-400 mt-1"></p>
              </div>

              <div id="main-content-area">
                </div>
          </div>
      </main>
      </div>
  <div id="preview-modal" class="fixed inset-0 bg-black/70 z-[120] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div id="preview-modal-panel" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl transform transition-all opacity-0 scale-95 flex flex-col max-h-[92vh]">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 id="preview-modal-title" class="font-poppins font-bold text-lg text-gray-800 dark:text-white">Certificate Preview</h3>
        <button type="button" id="close-preview-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i class="ri-close-line text-2xl"></i></button>
      </div>
      <div class="p-6 flex-grow overflow-auto bg-gray-100 dark:bg-gray-900">
        <div class="flex items-center justify-center">
          <div id="preview-container" class="relative shadow-lg w-full">
            <img id="preview-blanko" src="" class="w-full h-auto" alt="Template Background">
            <div id="preview-elements" class="absolute inset-0"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-700 gap-x-3">
        <button type="button" id="downloadCertBtn" class="px-5 py-2.5 text-sm font-medium bg-primary text-white rounded-lg hover:bg-primary-dark focus:outline-none focus:ring-4 focus:ring-primary/50 flex items-center gap-2">
            <i class="ri-download-2-line"></i>
            <span>Download PDF</span>
        </button>
        <button type="button" id="close-preview-modal-footer" class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ============================================================
         SETUP ASAS (SHELL UI)
         ============================================================ */
      const sidebar = document.getElementById('sidebar');
      const sidebarToggleBtn = document.getElementById('sidebar-toggle');
      const closeSidebarBtn = document.getElementById('close-sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      function openSidebar() { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
      function closeSidebar() { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
      sidebarToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
      closeSidebarBtn.addEventListener('click', closeSidebar);
      overlay.addEventListener('click', closeSidebar);
      document.querySelectorAll('[data-collapse-toggle]').forEach(button => {
        button.addEventListener('click', () => {
          const target = document.getElementById(button.getAttribute('data-collapse-toggle'));
          if (target) target.classList.toggle('hidden');
          button.querySelector('.ri-arrow-down-s-line')?.classList.toggle('rotate-180');
        });
      });
      const themeToggleBtn = document.getElementById('theme-toggle');
      const applyTheme = () => {
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      };
      applyTheme();
      themeToggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
      });
      const profileMenuButton = document.getElementById('profile-menu-button');
      const profileMenu = document.getElementById('profile-menu');
      profileMenuButton?.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('hidden'); });
      window.addEventListener('click', (e) => {
        if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenuButton.contains(e.target) && !profileMenu.contains(e.target)) {
          profileMenu.classList.add('hidden');
        }
      });
      document.getElementById('logout-sidebar').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "../landing/home.html"; });
      document.getElementById('logout-navbar').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "../landing/home.html"; });
      
      /* ============================================================
         DATA SAMPEL LENGKAP & PELBAGAI
         ============================================================ */
      const A4_LANDSCAPE = { width: 1123, height: 794 };
      const A4_PORTRAIT = { width: 794, height: 1123 };
      const DUMMY_ORG = { name: "Sekolah Menengah Kebangsaan Seri Bintang", add1: "Jalan 3/91, Taman Shamelin Perkasa", add2: "Batu 3 1/2 Cheras" };

      // ===== DI SINI SEMUA 6 SET DATA ELEMEN LENGKAP DARI GALLERY DITAKRIFKAN =====
      const fullPortraitLeft = [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:120, position_y:150, width:120, height:120, align:"left" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:120, position_y:280, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"left" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:120, position_y:305, font_family:"Montserrat", font_size:14, color:"#374151", align:"left" }, { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:120, position_y:325, font_family:"Montserrat", font_size:14, color:"#374151", align:"left" }, { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:120, position_y:400, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29", align:"left" }, { element_id:"certificate_body", type:"text", content:"Certificate body text here lorem ipsum dolor sit amet.", position_x:120, position_y:480, font_family:"Montserrat", font_size:16, color:"#374151", align:"left" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:120, position_y:530, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"left" }, { element_id:"event_description", type:"text", content:"Event description sample", position_x:120, position_y:570, font_family:"Montserrat", font_size:16, color:"#374151", align:"left" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:120, position_y:595, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827", align:"left" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:220, position_y:820, width:200, height:150, align:"center" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:220, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"center" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:220, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151", align:"center" }, { element_id:"signed_date", type:"text", content:"Tarikh: {Signed_Date}", position_x:120, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151", align:"left" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:674, position_y:950, width:100, height:100, align:"right" }, ];
      const fullPortraitCenter = [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:397, position_y:150, width:120, height:120, align:"center" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:397, position_y:280, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"center" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:397, position_y:305, font_family:"Montserrat", font_size:14, color:"#374151", align:"center" }, { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:397, position_y:400, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29", align:"center" }, { element_id:"certificate_body", type:"text", content:"Center aligned sample body text for the certificate.", position_x:397, position_y:480, font_family:"Montserrat", font_size:16, color:"#374151", align:"center" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:397, position_y:525, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"center" }, { element_id:"event_description", type:"text", content:"Event description here", position_x:397, position_y:565, font_family:"Montserrat", font_size:16, color:"#374151", align:"center" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:397, position_y:595, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827", align:"center" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:397, position_y:820, width:200, height:150, align:"center" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:397, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"center" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:397, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151", align:"center" }, { element_id:"signed_date", type:"text", content:"Tarikh: {Signed_Date}", position_x:120, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151", align:"left" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:674, position_y:950, width:100, height:100, align:"right" }, ];
      const fullPortraitRight = [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:674, position_y:150, width:120, height:120, align:"right" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:674, position_y:280, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"right" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:674, position_y:305, font_family:"Montserrat", font_size:14, color:"#374151", align:"right" }, { element_id:"address_2", type:"text", content:"{Address_row2}", position_x:674, position_y:325, font_family:"Montserrat", font_size:14, color:"#374151", align:"right" }, { element_id:"certificate_title", type:"text", content:"CERTIFICATE TITLE", position_x:674, position_y:400, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#AA8F29", align:"right" }, { element_id:"certificate_body", type:"text", content:"Body text sample at right side.", position_x:674, position_y:480, font_family:"Montserrat", font_size:16, color:"#374151", align:"right" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:674, position_y:532, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"right" }, { element_id:"event_description", type:"text", content:"Description right-aligned look", position_x:674, position_y:570, font_family:"Montserrat", font_size:16, color:"#374151", align:"right" }, { element_id:"event_date", type:"text", content:"on {Event_Date}", position_x:674, position_y:595, font_family:"Montserrat", font_size:16, font_weight:"600", color:"#111827", align:"right" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:674, position_y:820, width:200, height:150, align:"right" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:674, position_y:880, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"right" }, { element_id:"signatory_position", type:"text", content:"{Signatory_Position}", position_x:674, position_y:905, font_family:"Montserrat", font_size:14, color:"#374151", align:"right" }, { element_id:"signed_date", type:"text", content:"Tarikh: {Signed_Date}", position_x:674, position_y:950, font_family:"Montserrat", font_size:12, color:"#374151", align:"right" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:120, position_y:950, width:100, height:100, align:"left" }, ];
      const fullLandscapeLeft = [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:120, position_y:120, width:120, height:120, align:"left" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:120, position_y:250, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"left" }, { element_id:"address_1", type:"text", content:"{Address_row1}", position_x:120, position_y:275, font_family:"Montserrat", font_size:14, color:"#374151", align:"left" }, { element_id:"certificate_title", type:"text", content:"Sijil Penyertaan", position_x:120, position_y:350, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#991B1B", align:"left" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:120, position_y:450, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"left" }, { element_id:"event_description", type:"text", content:"kerana telah menyertai Kem Kepimpinan Pengawas Sekolah 2025.", position_x:120, position_y:485, font_family:"Montserrat", font_size:16, color:"#374151", align:"left" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:120, position_y:590, width:200, height:150, align:"left" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:120, position_y:660, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"left" }, { element_id:"signed_date", type:"text", content:"{Signed_Date}", position_x:120, position_y:700, font_family:"Montserrat", font_size:12, color:"#374151", align:"left" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:1003, position_y:674, width:100, height:100, align:"right" }, ];
      const fullLandscapeCenter = [ { element_id:"logo_1", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:120, position_y:120, width:120, height:120, align:"left" }, { element_id:"logo_2", type:"image", content:"../../src/images/logos-badges/logo-srsa.svg", position_x:1003, position_y:120, width:120, height:120, align:"right" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:561, position_y:250, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"center" }, { element_id:"certificate_title", type:"text", content:"Sijil Penghargaan", position_x:561, position_y:320, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#581C87", align:"center" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:561, position_y:410, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"center" }, { element_id:"event_description", type:"text", content:"sebagai Ahli Jawatankuasa Teknikal untuk Hari Sukan Tahunan 2025.", position_x:561, position_y:445, font_family:"Montserrat", font_size:16, color:"#374151", align:"center" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:561, position_y:580, width:200, height:150, align:"center" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:561, position_y:650, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"center" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:1003, position_y:674, width:100, height:100, align:"right" }, ];
      const fullLandscapeRight = [ { element_id:"logo", type:"image", content:"../../src/images/logos-badges/sample-logo.svg", position_x:1003, position_y:120, width:120, height:120, align:"right" }, { element_id:"organization_name", type:"text", content:"{Organization_Name}", position_x:1003, position_y:250, font_family:"Montserrat", font_size:18, font_weight:"600", color:"#111827", align:"right" }, { element_id:"certificate_title", type:"text", content:"Sijil Penghargaan Penceramah", position_x:1003, position_y:320, font_family:"EB Garamond", font_size:40, font_weight:"bold", color:"#000000", align:"right" }, { element_id:"recipient_name", type:"text", content:"{Recipient_Name}", position_x:1003, position_y:430, font_family:"Montserrat", font_size:20, font_weight:"bold", color:"#000000", align:"right" }, { element_id:"event_description", type:"text", content:"sebagai Penceramah Jemputan untuk ceramah 'Kerjaya Abad ke-21'.", position_x:1003, position_y:465, font_family:"Montserrat", font_size:16, color:"#374151", align:"right" }, { element_id:"signature_image", type:"image", content:"../../src/images/signatures/sample-signature.png", position_x:1003, position_y:590, width:200, height:150, align:"right" }, { element_id:"signatory_name", type:"text", content:"{Signatory_Name}", position_x:1003, position_y:660, font_family:"Montserrat", font_size:14, font_weight:"500", color:"#000000", align:"right" }, { element_id:"qr_code", type:"qrcode", content:"{Verification_URL}", position_x:120, position_y:674, width:100, height:100, align:"left" }, ];
      
      const RECIPIENT_DB = {
        "850115-10-5551": {
            name: "Ahmad Zaki",
            certificates: [
                { certificate_id: "CERT001", nama_sijil: "Sijil Kehadiran Penuh (P-Left, 2 Sign)", orientation: "Portrait", templateUrl: '../../src/images/templates/mdpl-green-001.svg', elements_Json: JSON.stringify(fullPortraitLeft), issued_date: "2025-08-31T10:00:00Z", created_by: "Cikgu Aminah", status: "Issued" },
                { certificate_id: "CERT002", nama_sijil: "Anugerah Pelajar Harapan (P-Center)", orientation: "Portrait", templateUrl: '../../src/images/templates/clpc-gold-010.svg', elements_Json: JSON.stringify(fullPortraitCenter), issued_date: "2025-07-20T11:00:00Z", created_by: "Admin", status: "Issued" },
                { certificate_id: "CERT003", nama_sijil: "Johan Pertandingan Catur (P-Right)", orientation: "Portrait", templateUrl: '../../src/images/templates/mdpr-blue-003.svg', elements_Json: JSON.stringify(fullPortraitRight), issued_date: "2025-06-15T12:00:00Z", created_by: "En. Kamal", status: "Draft" },
                { certificate_id: "CERT004", nama_sijil: "Peserta Kem Kepimpinan (L-Left)", orientation: "Landscape", templateUrl: '../../src/images/templates/clll-red-004.svg', elements_Json: JSON.stringify(fullLandscapeLeft), issued_date: "2025-05-10T13:00:00Z", created_by: "Pn. Aishah", status: "Issued" },
                { certificate_id: "CERT005", nama_sijil: "Penghargaan AJK Sukan (L-Center, 2 Logo)", orientation: "Landscape", templateUrl: '../../src/images/templates/mdlc-purple-003.svg', elements_Json: JSON.stringify(fullLandscapeCenter), issued_date: "2025-04-05T14:00:00Z", created_by: "Admin", status: "Issued" },
                { certificate_id: "CERT006", nama_sijil: "Penceramah Jemputan (L-Right)", orientation: "Landscape", templateUrl: '../../src/images/templates/cllr-black-006.svg', elements_Json: JSON.stringify(fullLandscapeRight), issued_date: "2025-03-01T15:00:00Z", created_by: "En. Rahman", status: "Issued" },
            ]
        }
      };
      
      /* ============================================================
         LOGIK UTAMA HALAMAN
         ============================================================ */
      let allCertificates = [];
      let currentPage = 1;
      const itemsPerPage = 5;

      const mainContentArea = document.getElementById('main-content-area');
      const pageHeader = document.getElementById('page-header');
      const recipientNameEl = document.getElementById('recipient-name');
      const recipientIdEl = document.getElementById('recipient-id');
      
      const previewModal = document.getElementById('preview-modal');
      const previewModalPanel = document.getElementById('preview-modal-panel');
      const previewModalTitle = document.getElementById('preview-modal-title');
      const closePreviewModalBtn = document.getElementById('close-preview-modal');
      const closePreviewModalFooterBtn = document.getElementById('close-preview-modal-footer');
      const downloadCertBtn = document.getElementById('downloadCertBtn');
      const previewContainer = document.getElementById('preview-container');
      const previewBlanko = document.getElementById('preview-blanko');
      const previewElements = document.getElementById('preview-elements');


      function init() {
        const params = new URLSearchParams(window.location.search);
        const nationalId = params.get('national_id');
        const recipientData = RECIPIENT_DB[nationalId];

        if (recipientData) {
          recipientNameEl.textContent = `Certificates for: ${recipientData.name}`;
          recipientIdEl.textContent = `National ID: ${nationalId}`;
          allCertificates = recipientData.certificates;
          
          mainContentArea.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                        <tr>
                            <th scope="col" class="px-6 py-3">#</th>
                            <th scope="col" class="px-6 py-3">Certificate Name</th>
                            <th scope="col" class="px-6 py-3">Creator</th>
                            <th scope="col" class="px-6 py-3">Issued Date</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="cert-table-body"></tbody>
                </table>
            </div>
            <div id="pagination-container" class="flex items-center justify-between mt-6"></div>`;
            renderPage();
        } else {
            pageHeader.classList.add('text-center');
            recipientNameEl.textContent = `Recipient Not Found`;
            recipientIdEl.textContent = ``;
            mainContentArea.innerHTML = `<div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-md"><div class="text-center"><i class="ri-search-eye-line text-6xl text-gray-400 mb-4"></i><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Search Unsuccessful</h2><p class="text-gray-500 mt-2">No record found for National ID: <strong>${nationalId || 'N/A'}</strong>. Please try another search.</p></div></div>`;
        }
      }
      
      function renderPage(){
          renderTable();
          renderPagination();
      }

      function renderTable() {
        const tableBody = document.getElementById('cert-table-body');
        tableBody.innerHTML = '';
        if (allCertificates.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10">No certificates found for this recipient.</td></tr>`;
          document.getElementById('pagination-container').innerHTML = '';
          return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageItems = allCertificates.slice(startIndex, startIndex + itemsPerPage);

        pageItems.forEach((cert, index) => {
          const row = document.createElement('tr');
          row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
          row.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${startIndex + index + 1}</td>
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${cert.nama_sijil}</td>
            <td class="px-6 py-4">${cert.created_by}</td>
            <td class="px-6 py-4">${new Date(cert.issued_date).toLocaleDateString('en-GB')}</td>
            <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${cert.status === 'Issued' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'}">${cert.status}</span></td>
            <td class="px-6 py-4 text-center">
              <button data-id="${cert.certificate_id}" title="Preview/Download" class="view-btn text-primary hover:text-primary-dark text-xl"><i class="ri-eye-line"></i></button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
      
      function renderPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(allCertificates.length / itemsPerPage);
        if (totalPages <= 1) return;

        const paginationHTML = `
          <span class="text-sm text-gray-700 dark:text-gray-400">Showing <span class="font-semibold text-gray-900 dark:text-white">${(currentPage - 1) * itemsPerPage + 1}</span> to <span class="font-semibold text-gray-900 dark:text-white">${Math.min(currentPage * itemsPerPage, allCertificates.length)}</span> of <span class="font-semibold text-gray-900 dark:text-white">${allCertificates.length}</span> certificates</span>
          <div class="inline-flex -space-x-px text-sm h-8">
            <button id="prev-page" class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>
            ${Array.from({ length: totalPages }, (_, i) => `<button data-page="${i + 1}" class="page-number-btn flex items-center justify-center px-3 h-8 leading-tight ${i + 1 === currentPage ? 'text-primary-dark border border-primary bg-primary-light dark:bg-gray-700 dark:border-primary' : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700'}">${i + 1}</button>`).join('')}
            <button id="next-page" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>
          </div>`;
        paginationContainer.innerHTML = paginationHTML;
        document.getElementById('prev-page').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
        document.getElementById('next-page').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderPage(); } });
        document.querySelectorAll('.page-number-btn').forEach(btn => btn.addEventListener('click', (e) => { currentPage = parseInt(e.target.dataset.page); renderPage(); }));
      }
      
      function showPreviewModal(certId) {
        const nationalId = new URLSearchParams(window.location.search).get('national_id');
        const recipient = RECIPIENT_DB[nationalId];
        const cert = recipient?.certificates.find(c => c.certificate_id === certId);
        if (!cert) { alert('Certificate data not found!'); return; }
        
        previewModalPanel.classList.remove('max-w-5xl', 'max-w-3xl');
        const isPortrait = cert.orientation.toLowerCase() === 'portrait';
        previewModalPanel.classList.add(isPortrait ? 'max-w-3xl' : 'max-w-5xl');
        
        previewModalTitle.textContent = `Preview: ${cert.nama_sijil}`;
        
        const templateWidth = isPortrait ? A4_PORTRAIT.width : A4_LANDSCAPE.width;
        const templateHeight = isPortrait ? A4_PORTRAIT.height : A4_LANDSCAPE.height;

        previewContainer.style.aspectRatio = `${templateWidth} / ${templateHeight}`;
        previewContainer.style.maxWidth = isPortrait ? '520px' : '900px';
        previewBlanko.src = cert.templateUrl;
        
        previewElements.innerHTML = '';
        setTimeout(() => {
          const rect = previewContainer.getBoundingClientRect();
          const scale = rect.width / templateWidth;
          previewElements.innerHTML = generateOverlayElements(cert, recipient, scale);
          renderQRCodesIn(previewElements);
        }, 50);

        previewModal.classList.remove('hidden');
        previewModal.classList.add('flex');
        setTimeout(() => previewModalPanel.classList.remove('opacity-0','scale-95'), 10);
      }
      
      function hidePreviewModal() {
        previewModalPanel.classList.add('opacity-0','scale-95');
        setTimeout(() => {
          previewModal.classList.add('hidden');
          previewModal.classList.remove('flex');
        }, 300);
      }

      function generateOverlayElements(certData, recipientData, scaleFactor) {
          const elements = JSON.parse(certData.elements_Json);
          const dynamicValues = {
            "{Recipient_Name}": recipientData.name.toUpperCase(),
            "{Organization_Name}": DUMMY_ORG.name,
            "{Address_row1}": DUMMY_ORG.add1,
            "{Address_row2}": DUMMY_ORG.add2,
            "{Event_Date}": new Date(certData.issued_date).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }),
            "{Signed_Date}": new Date(certData.issued_date).toLocaleDateString('ms-MY'),
            "{Signatory_Name}": "Pn. Hjh. Rozita Binti Mad Isa",
            "{Signatory_Position}": "Pengetua Cemerlang",
            "{Verification_URL}": `https://des.mysertifico.com/verify.html?id=${certData.certificate_id}`
          };
          
          return elements.map(el => {
              let content = el.content || '';
              for (const placeholder in dynamicValues) {
                  content = content.replace(new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), dynamicValues[placeholder]);
              }

              const templateWidth = certData.orientation === 'Landscape' ? A4_LANDSCAPE.width : A4_PORTRAIT.width;
              const templateHeight = certData.orientation === 'Landscape' ? A4_LANDSCAPE.height : A4_PORTRAIT.height;
              
              let baseStyle = `top:${(el.position_y / templateHeight) * 100}%; left:${(el.position_x / templateWidth) * 100}%;`;
              const align = el.align || 'left';
              let transform = 'translateY(-50%)';
              if (align === 'center') transform = 'translate(-50%, -50%)';
              if (align === 'right') transform = 'translate(-100%, -50%)';
              baseStyle += `transform:${transform};`;

              if (el.type === 'text') {
                  baseStyle += `font-family:'${el.font_family}', sans-serif; font-size:${el.font_size * scaleFactor}px; font-weight:${el.font_weight || 'normal'}; color:${el.color}; text-align:${align};`;
                  return `<div class="preview-element" style="${baseStyle}">${content}</div>`;
              }
              if (el.type === 'image') {
                  baseStyle += `width:${el.width * scaleFactor}px; height:${el.height * scaleFactor}px;`;
                  return `<img class="preview-element" src="${content}" style="${baseStyle}" alt="${el.element_id}">`;
              }
              if (el.type === 'qrcode') {
                  baseStyle += `width:${el.width * scaleFactor}px; height:${el.height * scaleFactor}px;`;
                  return `<div class="preview-element qr-holder" data-text="${content}" style="${baseStyle}"></div>`;
              }
              return '';
          }).join('');
      }

      function renderQRCodesIn(container) {
          const holders = container.querySelectorAll('.qr-holder');
          holders.forEach(holder => {
              const text = holder.dataset.text || '';
              const width = parseFloat(holder.style.width) || 100;
              holder.innerHTML = '';
              if (text) new QRCode(holder, { text, width, height: width, colorDark: "#000", colorLight: "#fff" });
          });
      }
      
      // Event listener perlu diletakkan pada elemen yang wujud semasa DOMContentLoaded
      document.getElementById('main-content-area').addEventListener('click', (e) => {
        const viewButton = e.target.closest('.view-btn');
        if (viewButton) showPreviewModal(viewButton.dataset.id);
      });
      closePreviewModal.addEventListener('click', hidePreviewModal);
      closePreviewModalFooter.addEventListener('click', hidePreviewModal);
      previewModal.addEventListener('click', (e) => { if (e.target === previewModal) hidePreviewModal(); });
      
      init();
    });
  </script>
</body>
</html>